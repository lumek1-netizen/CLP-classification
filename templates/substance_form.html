{% extends "base.html" %}

{% block content %}
<!-- Page Header (Sticky) -->
<div class="page-header">
    <div class="page-header__content">
        <div class="page-title-group">
            <div class="breadcrumbs">
                <a href="{{ url_for('substances.index') }}" class="text-muted" style="text-decoration: none;">L√°tky</a>
                <span class="text-secondary">/</span>
                <span>{{ 'Editace' if substance and substance.id else 'Nov√°' }}</span>
            </div>
            <h1 class="page-title">
                {% if substance and substance.id %}
                Editovat: <span class="text-primary">{{ substance.name }}</span>
                {% else %}
                Nov√° L√°tka
                {% endif %}
            </h1>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('substances.index') }}" class="button button-secondary">Zru≈°it</a>
            <button type="submit" form="substance-form" class="button button-primary">
                {% if substance and substance.id %}
                üíæ Ulo≈æit zmƒõny
                {% else %}
                ‚úÖ Vytvo≈ôit l√°tku
                {% endif %}
            </button>
        </div>
    </div>
</div>

<div class="container container-narrow"> <!-- narrow container for better form readability -->

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST"
        action="{{ url_for('substances.edit', substance_id=substance.id) if substance and substance.id else url_for('substances.create') }}"
        id="substance-form">
        {{ form.hidden_tag() }}

        <!-- 1. Z√°kladn√≠ Identifikace -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">üè∑Ô∏è Z√°kladn√≠ Identifikace</h2>
            </div>
            <div class="card__body">
                <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <div class="form-group">
                        <label for="name" class="form-label">N√°zev L√°tky <span class="text-danger">*</span></label>
                        {{ form.name(id="name", class="form-control", placeholder="Nap≈ô. Ethanol") }}
                        {% for error in form.name.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>

                    <div class="form-group">
                        <label for="cas_number" class="form-label">CAS ƒå√≠slo</label>
                        <div class="input-group">
                            {{ form.cas_number(id="cas_number", class="form-control", placeholder="Nap≈ô. 64-17-5") }}
                            <button type="button" id="btn_fetch_echa" class="button button-secondary"
                                title="Ovƒõ≈ôit a doplnit data z ECHA datab√°ze">
                                üîç Ovƒõ≈ôit z ECHA
                            </button>
                        </div>
                        {% for error in form.cas_number.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group mt-4">
                    <label class="form-label mb-2">GHS K√≥dy (Piktogramy)</label>
                    {{ form.ghs_codes(id="ghs_codes", type="hidden") }}

                    <div id="ghs_selection_grid" class="d-grid gap-3"
                        style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                        <!-- JS filled -->
                    </div>

                    {% for error in form.ghs_codes.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 2. H-Vƒõty (Fyzik√°ln√≠) -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">üí• H-Vƒõty (Fyzik√°ln√≠ nebezpeƒçnost)</h2>
            </div>
            <div class="card__body">
                <div class="checkbox-group" style="column-count: 2; column-gap: 2rem;">
                    {% for code, description in physical_h_phrases.items() %}
                    <div class="form-check break-inside-avoid mb-2">
                        <input class="form-check-input mt-1" type="checkbox" name="physical_h_phrases"
                            value="{{ code }}" id="physical_{{ code }}" {% if code in selected_physical_h_phrases
                            %}checked{% endif %}>
                        <label class="form-check-label text-sm leading-tight ml-2" for="physical_{{ code }}">
                            <strong class="text-danger">{{ code }}</strong>: {{ description }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 3. H-Vƒõty (Zdrav√≠) -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">‚öïÔ∏è H-Vƒõty (Zdrav√≠)</h2>
            </div>
            <div class="card__body">
                <div class="checkbox-group" style="column-count: 2; column-gap: 2rem;">
                    {% for code, description in health_h_phrases.items() %}
                    <div class="form-check break-inside-avoid mb-2">
                        <input class="form-check-input mt-1" type="checkbox" name="health_h_phrases" value="{{ code }}"
                            id="health_{{ code }}" {% if code in selected_health_h_phrases %}checked{% endif %}>
                        <label class="form-check-label text-sm leading-tight ml-2" for="health_{{ code }}">
                            <strong class="text-primary">{{ code }}</strong>: {{ description }}
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <hr class="border-color my-4">
                <h3 class="text-sm font-bold mb-3 text-secondary">Dal≈°√≠ zdravotn√≠ rizika</h3>
                <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label for="ed_hh_cat" class="form-label text-sm">{{ form.ed_hh_cat.label.text }}</label>
                        {{ form.ed_hh_cat(id="ed_hh_cat", class="form-control form-control-sm") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. H-Vƒõty (Prost≈ôed√≠) -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">üå≥ H-Vƒõty (≈Ωivotn√≠ Prost≈ôed√≠)</h2>
            </div>
            <div class="card__body">
                <div class="checkbox-group">
                    {% for code, description in env_h_phrases.items() %}
                    <div class="form-check mb-2">
                        <input class="form-check-input mt-1" type="checkbox" name="env_h_phrases" value="{{ code }}"
                            id="env_{{ code }}" {% if code in selected_env_h_phrases %}checked{% endif %}>
                        <label class="form-check-label text-sm ml-2" for="env_{{ code }}">
                            <strong class="text-success">{{ code }}</strong>: {{ description }}
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <hr class="border-color my-4">
                <h3 class="text-sm font-bold mb-3 text-secondary">Dal≈°√≠ environment√°ln√≠ rizika</h3>
                <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label for="ed_env_cat" class="form-label text-sm">{{ form.ed_env_cat.label.text }}</label>
                        {{ form.ed_env_cat(id="ed_env_cat", class="form-control form-control-sm") }}
                    </div>
                </div>

                <div class="d-grid gap-2 mt-3" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                    <div class="form-check">
                        {{ form.is_pbt(id="is_pbt", class="form-check-input") }}
                        <label for="is_pbt" class="ml-2">PBT <sup class="info-tooltip"
                                title="Perzistentn√≠, bioakumulativn√≠ a toxick√° l√°tka">‚ìò</sup></label>
                    </div>
                    <div class="form-check">
                        {{ form.is_vpvb(id="is_vpvb", class="form-check-input") }}
                        <label for="is_vpvb" class="ml-2">vPvB <sup class="info-tooltip"
                                title="Vysoce perzistentn√≠ a vysoce bioakumulativn√≠ l√°tka">‚ìò</sup></label>
                    </div>
                    <div class="form-check">
                        {{ form.is_pmt(id="is_pmt", class="form-check-input") }}
                        <label for="is_pmt" class="ml-2">PMT <sup class="info-tooltip"
                                title="Perzistentn√≠, mobiln√≠ a toxick√° l√°tka">‚ìò</sup></label>
                    </div>
                    <div class="form-check">
                        {{ form.is_vpvm(id="is_vpvm", class="form-check-input") }}
                        <label for="is_vpvm" class="ml-2">vPvM <sup class="info-tooltip"
                                title="Vysoce perzistentn√≠ a vysoce mobiln√≠ l√°tka">‚ìò</sup></label>
                    </div>
                    <div class="form-check">
                        {{ form.is_svhc(id="is_svhc", class="form-check-input") }}
                        <label for="is_svhc" class="ml-2 fw-bold text-danger">SVHC <sup class="info-tooltip"
                                style="color:red;"
                                title="L√°tka vzbuzuj√≠c√≠ mimo≈ô√°dn√© obavy (Substance of Very High Concern)">‚ìò</sup></label>
                    </div>
                </div>

                <hr class="border-color my-4">
                <h3 class="text-sm font-bold mb-3 text-secondary">Legislativn√≠ Status (REACH)</h3>
                <div class="d-grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                    <div class="form-check">
                        {{ form.is_reach_annex_xiv(id="is_reach_annex_xiv", class="form-check-input") }}
                        <label for="is_reach_annex_xiv" class="ml-2">REACH P≈ô√≠loha XIV <sup class="info-tooltip"
                                title="Seznam l√°tek podl√©haj√≠c√≠ch povolen√≠">‚ìò</sup></label>
                    </div>
                    <div class="form-check">
                        {{ form.is_reach_annex_xvii(id="is_reach_annex_xvii", class="form-check-input") }}
                        <label for="is_reach_annex_xvii" class="ml-2">REACH P≈ô√≠loha XVII <sup class="info-tooltip"
                                title="Omezen√≠ v√Ωroby, uv√°dƒõn√≠ na trh a pou≈æ√≠v√°n√≠ nƒõkter√Ωch nebezpeƒçn√Ωch l√°tek">‚ìò</sup></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1.1 Molecular Weight (New) -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">‚öñÔ∏è Fyzik√°ln√≠ vlastnosti</h2>
            </div>
            <div class="card__body">
                <div class="form-group">
                    <label for="molecular_weight" class="form-label label-with-tooltip">
                        Molekulov√° hmotnost (g/mol)
                        <span class="text-secondary cursor-help"
                            title="Nutn√© pro p≈ôepoƒçet jednotek u plyn≈Ø (mg/l <-> ppm)">‚ìò</span>
                    </label>
                    {{ form.molecular_weight(id="molecular_weight", class="form-control flexible-float", step="0.01",
                    min="0",
                    placeholder="Nap≈ô. 44.01") }}
                    {% for error in form.molecular_weight.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 4. Akutn√≠ Toxicita (ATE) -->
        <div class="card mb-6">
            <div class="card__header">
                <h2 class="card__title">üß™ Akutn√≠ Toxicita (ATE Hodnoty)</h2>
            </div>
            <div class="card__body">
                <p class="text-muted text-sm mb-4">Zad√°vejte hodnoty pro v√Ωpoƒçet klasifikace smƒõs√≠. Nechte pr√°zdn√©,
                    pokud nen√≠ relevantn√≠.</p>

                <div class="d-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Oral -->
                    <div class="form-group">
                        <label for="ate_oral" class="form-label label-with-tooltip" style="min-height: 2rem;">
                            Or√°ln√≠ (mg/kg)
                            <span class="text-secondary cursor-help"
                                title="Hodnota LD50 v mg/kg tƒõlesn√© hmotnosti">‚ìò</span>
                        </label>
                        {{ form.ate_oral(id="ate_oral", class="form-control", step="0.01", min="0", placeholder="Nap≈ô.
                        300") }}
                        {% for error in form.ate_oral.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>

                    <!-- Dermal -->
                    <div class="form-group">
                        <label for="ate_dermal" class="form-label label-with-tooltip" style="min-height: 2rem;">
                            Derm√°ln√≠ (mg/kg)
                            <span class="text-secondary cursor-help"
                                title="Hodnota LD50 v mg/kg tƒõlesn√© hmotnosti">‚ìò</span>
                        </label>
                        {{ form.ate_dermal(id="ate_dermal", class="form-control", step="0.01", min="0",
                        placeholder="Nap≈ô. 1100") }}
                        {% for error in form.ate_dermal.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>

                    <!-- Inhalation Vapours -->
                    <div class="form-group">
                        <label for="ate_inhalation_vapours" class="form-label" style="min-height: 2rem;">Inhalaƒçn√≠ -
                            P√°ry (mg/l)</label>
                        {{ form.ate_inhalation_vapours(id="ate_inhalation_vapours", class="form-control", step="0.01",
                        min="0", placeholder="Nap≈ô. 15.0") }}
                        <div id="warn_vapours" class="text-warning text-xs mt-1" style="display:none;">‚ö†Ô∏è Vysok√° hodnota
                            (>100 mg/l)</div>
                        {% for error in form.ate_inhalation_vapours.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>

                    <!-- Inhalation Dusts -->
                    <div class="form-group">
                        <label for="ate_inhalation_dusts_mists" class="form-label" style="min-height: 2rem;">Inhalaƒçn√≠ -
                            Prach/Mlha (mg/l)</label>
                        {{ form.ate_inhalation_dusts_mists(id="ate_inhalation_dusts_mists", class="form-control",
                        step="0.01", min="0", placeholder="Nap≈ô. 0.8") }}
                        <div id="warn_dusts" class="text-warning text-xs mt-1" style="display:none;">‚ö†Ô∏è Vysok√° hodnota
                            (>100 mg/l)</div>
                        {% for error in form.ate_inhalation_dusts_mists.errors %}
                        <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>

                    <!-- Inhalation Gases (Enhanced) -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label for="ate_inhalation_gases" class="form-label mb-0">Inhalaƒçn√≠ - Plyny</label>

                            <!-- Unit Toggle -->
                            <div class="unit-toggle d-flex bg-secondary rounded p-1" style="width: fit-content;">
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input" type="radio" name="gas_unit" id="unit_ppm"
                                        value="ppm" checked>
                                    <label class="form-check-label text-xs fw-bold px-2" for="unit_ppm"
                                        style="cursor:pointer;">ppmV</label>
                                </div>
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input" type="radio" name="gas_unit" id="unit_mgl"
                                        value="mgl">
                                    <label class="form-check-label text-xs fw-bold px-2" for="unit_mgl"
                                        style="cursor:pointer;">mg/l</label>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            {{ form.ate_inhalation_gases(id="ate_inhalation_gases", class="form-control", step="1",
                            min="0", placeholder="Nap≈ô. 4500") }}
                            <span class="input-group-text text-sm" id="gas_unit_display">ppmV</span>
                        </div>

                        <div id="mgl_conversion_info" class="text-info text-xs mt-1" style="display:none;">
                            ‚ÑπÔ∏è Bude p≈ôepoƒçteno na ppm: <code>ppm = (mg/l * 24450) / MW</code>
                        </div>
                        <div id="mw_missing_warning" class="text-danger text-xs mt-1" style="display:none;">
                            ‚ùó Pro zad√°n√≠ v mg/l mus√≠te vyplnit Molekulovou hmotnost!
                        </div>

                        <div id="warn_gases" class="text-warning text-xs mt-1" style="display:none;">‚ö†Ô∏è N√≠zk√° hodnota (
                            <100 ppm)</div>
                                {% for error in form.ate_inhalation_gases.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. M-Faktor -->
            <div class="card mb-6">
                <div class="card__header">
                    <h2 class="card__title">üß¨ M-Faktor (M-Factor)</h2>
                </div>
                <div class="card__body">
                    <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="form-group">
                            <label for="m_factor_acute" class="form-label label-with-tooltip">
                                M-Faktor Akutn√≠ (Acute 1)
                                <span class="text-secondary cursor-help" title="Hodnoty: 1, 10, 100, 1000...">‚ìò</span>
                            </label>
                            {{ form.m_factor_acute(id="m_factor_acute", class="form-control", step="1", min="1",
                            placeholder="Standard: 1") }}
                            {% for error in form.m_factor_acute.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="form-group">
                            <label for="m_factor_chronic" class="form-label label-with-tooltip">
                                M-Faktor Chronick√Ω (Chronic 1)
                                <span class="text-secondary cursor-help" title="Hodnoty: 1, 10, 100, 1000...">‚ìò</span>
                            </label>
                            {{ form.m_factor_chronic(id="m_factor_chronic", class="form-control", step="1", min="1",
                            placeholder="Standard: 1") }}
                            {% for error in form.m_factor_chronic.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>


            <!-- 6. Ekotoxick√© parametry (CLP 4.1) -->
            <div class="card mb-6">
                <div class="card__header">
                    <h2 class="card__title">üåä Ekotoxick√© parametry (T≈ô√≠da 4.1 - Vodn√≠ prost≈ôed√≠)</h2>
                </div>
                <div class="card__body">
                    <p class="text-muted text-sm mb-4">
                        Standardn√≠ testy pro klasifikaci akutn√≠ a chronick√© toxicity pro vodn√≠ organismy podle P≈ô√≠lohy
                        I, ƒç√°st 4.1 na≈ô√≠zen√≠ CLP.
                    </p>

                    <!-- Akutn√≠ toxicita - vodn√≠ prost≈ôed√≠ -->
                    <fieldset class="mb-5">
                        <legend class="text-sm font-bold text-primary mb-3">
                            üêü Akutn√≠ toxicita pro vodn√≠ organismy
                            <span class="text-secondary cursor-help"
                                title="Standardn√≠ testy pro klasifikaci Aquatic Acute kategorie 1">‚ìò</span>
                        </legend>

                        <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
                            <!-- LC50 ryby, 96h -->
                            <div class="form-group">
                                <label for="lc50_fish_96h" class="form-label label-with-tooltip">
                                    LC50 ryby, 96h (mg/L)
                                    <span class="text-secondary cursor-help"
                                        title="Let√°ln√≠ koncentrace 50% - ryby (nap≈ô. Danio rerio), 96 hodin">‚ìò</span>
                                </label>
                                {{ form.lc50_fish_96h(id="lc50_fish_96h", class="form-control", step="0.001", min="0",
                                placeholder="Nap≈ô. 1.0") }}
                                {% for error in form.lc50_fish_96h.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <!-- EC50 daphnie, 48h -->
                            <div class="form-group">
                                <label for="ec50_daphnia_48h" class="form-label label-with-tooltip">
                                    EC50 daphnie, 48h (mg/L)
                                    <span class="text-secondary cursor-help"
                                        title="Efektivn√≠ koncentrace 50% - Daphnia magna, 48 hodin">‚ìò</span>
                                </label>
                                {{ form.ec50_daphnia_48h(id="ec50_daphnia_48h", class="form-control", step="0.001",
                                min="0", placeholder="Nap≈ô. 0.5") }}
                                {% for error in form.ec50_daphnia_48h.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <!-- EC50 ≈ôasy, 72h -->
                            <div class="form-group">
                                <label for="ec50_algae_72h" class="form-label label-with-tooltip">
                                    EC50 ≈ôasy, 72h (mg/L)
                                    <span class="text-secondary cursor-help"
                                        title="Efektivn√≠ koncentrace 50% - ≈ôasy (nap≈ô. Pseudokirchneriella subcapitata), 72 hodin">‚ìò</span>
                                </label>
                                {{ form.ec50_algae_72h(id="ec50_algae_72h", class="form-control", step="0.001", min="0",
                                placeholder="Nap≈ô. 0.3") }}
                                {% for error in form.ec50_algae_72h.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        </div>
                    </fieldset>

                    <!-- Chronick√° toxicita -->
                    <fieldset class="mb-5">
                        <legend class="text-sm font-bold text-success mb-3">
                            üå± Chronick√° toxicita
                            <span class="text-secondary cursor-help"
                                title="Pro klasifikaci Aquatic Chronic kategori√≠ 1-4">‚ìò</span>
                        </legend>

                        <div class="form-group" style="max-width: 300px;">
                            <label for="noec_chronic" class="form-label label-with-tooltip">
                                NOEC (mg/L)
                                <span class="text-secondary cursor-help"
                                    title="No Observed Effect Concentration - koncentrace bez pozorovan√©ho √∫ƒçinku">‚ìò</span>
                            </label>
                            {{ form.noec_chronic(id="noec_chronic", class="form-control", step="0.001", min="0",
                            placeholder="Nap≈ô. 0.1") }}
                            {% for error in form.noec_chronic.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>
                    </fieldset>

                    <!-- Toxicita pro savce -->
                    <fieldset>
                        <legend class="text-sm font-bold text-danger mb-3">
                            üê≠ Toxicita pro savce
                            <span class="text-secondary cursor-help"
                                title="Pro dopl≈àkovou klasifikaci a v√Ωpoƒçty">‚ìò</span>
                        </legend>

                        <div class="d-grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
                            <!-- LD50 or√°ln√≠, savci -->
                            <div class="form-group">
                                <label for="ld50_oral_mammal" class="form-label label-with-tooltip">
                                    LD50 or√°ln√≠, savci (mg/kg)
                                    <span class="text-secondary cursor-help"
                                        title="Let√°ln√≠ d√°vka 50% - or√°ln√≠ pod√°n√≠, savci (nap≈ô. potkan)">‚ìò</span>
                                </label>
                                {{ form.ld50_oral_mammal(id="ld50_oral_mammal", class="form-control", step="0.01",
                                min="0", placeholder="Nap≈ô. 50") }}
                                {% for error in form.ld50_oral_mammal.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <!-- LD50 derm√°ln√≠, savci -->
                            <div class="form-group">
                                <label for="ld50_dermal_mammal" class="form-label label-with-tooltip">
                                    LD50 derm√°ln√≠, savci (mg/kg)
                                    <span class="text-secondary cursor-help"
                                        title="Let√°ln√≠ d√°vka 50% - derm√°ln√≠ aplikace, savci (nap≈ô. kr√°l√≠k)">‚ìò</span>
                                </label>
                                {{ form.ld50_dermal_mammal(id="ld50_dermal_mammal", class="form-control", step="0.01",
                                min="0", placeholder="Nap≈ô. 100") }}
                                {% for error in form.ld50_dermal_mammal.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <!-- LC50 inhalace, potkani, 4h -->
                            <div class="form-group">
                                <label for="lc50_inhalation_rat_4h" class="form-label label-with-tooltip">
                                    LC50 inhalace, potkani, 4h (mg/L)
                                    <span class="text-secondary cursor-help"
                                        title="Let√°ln√≠ koncentrace 50% - inhalace, potkani, 4 hodiny">‚ìò</span>
                                </label>
                                {{ form.lc50_inhalation_rat_4h(id="lc50_inhalation_rat_4h", class="form-control",
                                step="0.001", min="0", placeholder="Nap≈ô. 5.0") }}
                                {% for error in form.lc50_inhalation_rat_4h.errors %}
                                <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>



            <!-- 7. SCL Limits -->
            <div class="card mb-6">
                <div class="card__header">
                    <h2 class="card__title">üìë Specifick√© Koncentraƒçn√≠ Limity (SCLs)</h2>
                </div>
                <div class="card__body">
                    <div class="form-group" id="scl_form_group">
                        <div id="scl_container" class="d-grid gap-3 mb-3">
                            <!-- SCL Rows -->
                        </div>

                        <button type="button" id="add_scl_button" class="button button-secondary button-small">
                            ‚ûï P≈ôidat SCL
                        </button>

                        {{ form.scl_limits(id="scl_limits", type="hidden") }}

                        <p class="text-muted text-xs mt-2">Definujte specifick√© limity pro klasifikaci smƒõs√≠.</p>
                    </div>
                </div>
            </div>

    </form>

    <!-- 8. Audit Log -->
    {% if audit_logs %}
    <div class="card mt-8">
        <div class="card__header">
            <h2 class="card__title">üìú Historie zmƒõn</h2>
        </div>
        <div class="card__body p-0">
            <div class="table-responsive">
                <table class="table-clean text-sm">
                    <thead>
                        <tr>
                            <th style="width: 20%;">ƒåas</th>
                            <th style="width: 20%;">U≈æivatel</th>
                            <th style="width: 15%;">Akce</th>
                            <th style="width: 45%;">Detaily</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in audit_logs %}
                        <tr>
                            <td class="text-muted">{{ log.timestamp.strftime('%d.%m.%Y') }}</td>
                            <td class="font-medium">{{ log.user.username if log.user else 'Syst√©m' }}</td>
                            <td>
                                <span
                                    class="badge {% if log.action == 'CREATE' %}badge-success{% elif log.action == 'UPDATE' %}badge-warning{% else %}badge-danger{% endif %}">
                                    {{ log.action }}
                                </span>
                            </td>
                            <td>
                                {% if log.action == 'UPDATE' and log.changes %}
                                {% for field, diff in log.changes.items() %}
                                <div class="mb-1">
                                    <code class="text-xs bg-secondary rounded px-1">{{ field }}</code>:
                                    <span class="text-muted strike">{{ diff.old or '‚Äî' }}</span> ‚û°Ô∏è
                                    <span class="text-success">{{ diff.new or '‚Äî' }}</span>
                                </div>
                                {% endfor %}
                                {% else %}
                                {{ log.action.capitalize() }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- CSS for GHS Grid Selection -->
<style>
    .ghs-item {
        border: 2px solid var(--border-color);
        border-radius: var(--radius);
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--card-bg);
    }

    .ghs-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .ghs-item.selected {
        border-color: var(--primary-color);
        background-color: color-mix(in srgb, var(--primary-color), white 90%);
        box-shadow: 0 0 0 1px var(--primary-color);
    }

    .ghs-item img {
        width: 48px;
        height: 48px;
        object-fit: contain;
        margin-bottom: 0.25rem;
    }

    .ghs-item .ghs-code {
        font-weight: 700;
        font-size: 0.75rem;
        color: var(--text-primary);
    }

    .ghs-item .ghs-desc {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-align: center;
        line-height: 1.1;
    }

    .scl-row {
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background-color: var(--bg-secondary);
        padding: 1rem;
    }
</style>

<script nonce="{{ csp_nonce() }}">
    // --- GHS Selection Logic ---
    const GHS_DATA = [
        { code: 'GHS01', desc: 'V√Ωbu≈°n√©', img: '{{ url_for("static", filename="GHS_Symbols/GHS01.gif") }}' },
        { code: 'GHS02', desc: 'Ho≈ôlav√©', img: '{{ url_for("static", filename="GHS_Symbols/GHS02.gif") }}' },
        { code: 'GHS03', desc: 'Oxiduj√≠c√≠', img: '{{ url_for("static", filename="GHS_Symbols/GHS03.gif") }}' },
        { code: 'GHS04', desc: 'Plyny pod tlakem', img: '{{ url_for("static", filename="GHS_Symbols/GHS04.gif") }}' },
        { code: 'GHS05', desc: 'Korozivn√≠', img: '{{ url_for("static", filename="GHS_Symbols/GHS05.gif") }}' },
        { code: 'GHS06', desc: 'Toxick√©', img: '{{ url_for("static", filename="GHS_Symbols/GHS06.gif") }}' },
        { code: 'GHS07', desc: 'Dr√°≈ædiv√©', img: '{{ url_for("static", filename="GHS_Symbols/GHS07.gif") }}' },
        { code: 'GHS08', desc: 'Nebezpeƒçn√© pro zdrav√≠', img: '{{ url_for("static", filename="GHS_Symbols/GHS08.gif") }}' },
        { code: 'GHS09', desc: 'Nebezpeƒçn√© pro ≈æ√≠votn√≠ prost≈ôed√≠', img: '{{ url_for("static", filename="GHS_Symbols/GHS09.gif") }}' }
    ];

    const ghsInput = document.getElementById('ghs_codes');
    const ghsGrid = document.getElementById('ghs_selection_grid');

    function renderGhsGrid() {
        const currentValues = ghsInput.value.split(',').map(s => s.trim()).filter(s => s);

        ghsGrid.innerHTML = '';
        GHS_DATA.forEach(item => {
            const div = document.createElement('div');
            div.className = 'ghs-item';
            if (currentValues.includes(item.code)) {
                div.classList.add('selected');
            }

            const img = document.createElement('img');
            // Basic error handling for images
            img.onerror = function () { this.style.display = 'none'; };
            img.src = item.img;
            img.alt = item.code;
            div.appendChild(img);

            const codeSpan = document.createElement('span');
            codeSpan.className = 'ghs-code';
            codeSpan.textContent = item.code;
            div.appendChild(codeSpan);

            const descSpan = document.createElement('div');
            descSpan.className = 'ghs-desc';
            descSpan.textContent = item.desc;
            div.appendChild(descSpan);

            div.addEventListener('click', () => {
                div.classList.toggle('selected');
                updateGhsInput();
            });

            ghsGrid.appendChild(div);
        });
    }

    function updateGhsInput() {
        const selectedItems = [];
        const items = ghsGrid.querySelectorAll('.ghs-item.selected');
        items.forEach(item => {
            const code = item.querySelector('.ghs-code').textContent;
            selectedItems.push(code);
        });
        ghsInput.value = selectedItems.join(', ');
    }

    if (ghsGrid && ghsInput) {
        renderGhsGrid();
    }

    // --- SCL Logic (Preserved) ---
    const SCL_HAZARD_CATEGORIES = {{ scl_hazard_categories | tojson | safe }};
    const sclContainer = document.getElementById('scl_container');
    const addSclButton = document.getElementById('add_scl_button');
    const sclDataInput = document.getElementById('scl_limits');

    function serializeScls() {
        const rows = sclContainer.querySelectorAll('.scl-row');
        const scls = [];
        rows.forEach(row => {
            const hazard = row.querySelector('.scl-hazard').value;
            if (!hazard) return;
            const conds = [];
            const op1 = row.querySelector('.scl-op1').value;
            const val1 = row.querySelector('.scl-val1').value;
            if (op1 && val1 && !isNaN(parseFloat(val1))) {
                conds.push(`${op1} ${parseFloat(val1)}`);
            }
            const rangeCheck = row.querySelector('.scl-range-check');
            if (rangeCheck && rangeCheck.checked) {
                const op2 = row.querySelector('.scl-op2').value;
                const val2 = row.querySelector('.scl-val2').value;
                if (op2 && val2 && !isNaN(parseFloat(val2))) {
                    conds.push(`${op2} ${parseFloat(val2)}`);
                }
            }
            if (conds.length > 0) {
                scls.push(`${hazard}: ${conds.join('; ')}`);
            }
        });
        sclDataInput.value = scls.join(', ');
    }

    function createOperatorSelect(className, defaultValue = '>=') {
        const select = document.createElement('select');
        select.className = `${className} form-control form-select-sm`;
        select.style.maxWidth = '70px';
        ['>=', '>', '<=', '<'].forEach(op => {
            const opt = document.createElement('option');
            opt.value = op;
            opt.textContent = op;
            if (op === defaultValue) opt.selected = true;
            select.appendChild(opt);
        });
        return select;
    }

    function createSclRow(defaultHazard = '', cond1 = { op: '>=', val: '' }, cond2 = null) {
        const div = document.createElement('div');
        div.className = 'scl-row';

        const topRow = document.createElement('div');
        topRow.className = 'd-flex justify-content-between align-items-center mb-2';

        const hazardHeading = document.createElement('strong');
        hazardHeading.className = 'text-sm';
        hazardHeading.textContent = 'Kategorie nebezpeƒçnosti:';
        topRow.appendChild(hazardHeading);

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'button button-text text-danger button-small';
        removeButton.innerHTML = 'üóëÔ∏è Odstranit';
        removeButton.addEventListener('click', () => {
            div.remove();
            serializeScls();
        });
        topRow.appendChild(removeButton);
        div.appendChild(topRow);

        const selectHazard = document.createElement('select');
        selectHazard.className = 'scl-hazard form-control mb-3';
        let initialOption = document.createElement('option');
        initialOption.value = '';
        initialOption.textContent = 'Vyberte nebezpeƒç√≠...';
        selectHazard.appendChild(initialOption);
        SCL_HAZARD_CATEGORIES.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            if (category === defaultHazard) option.selected = true;
            selectHazard.appendChild(option);
        });
        div.appendChild(selectHazard);

        const condsContainer = document.createElement('div');
        condsContainer.className = 'd-flex flex-wrap align-items-center gap-3';

        // Row 1
        const row1 = document.createElement('div');
        row1.className = 'd-flex align-items-center gap-2';
        row1.appendChild(document.createTextNode('C '));
        const op1Select = createOperatorSelect('scl-op1', cond1.op);
        row1.appendChild(op1Select);
        const val1Input = document.createElement('input');
        val1Input.type = 'number';
        val1Input.step = '0.01';
        val1Input.className = 'scl-val1 form-control form-control-sm';
        val1Input.style.maxWidth = '80px';
        val1Input.placeholder = '%';
        val1Input.value = cond1.val;
        row1.appendChild(val1Input);
        row1.appendChild(document.createTextNode('%'));
        condsContainer.appendChild(row1);

        // Row 2
        const row2 = document.createElement('div');
        row2.className = 'scl-row2 d-flex align-items-center gap-2';
        row2.style.display = cond2 ? 'flex' : 'none';

        // Separator
        const sep = document.createElement('span');
        sep.textContent = 'a';
        sep.className = 'text-muted text-sm mx-1';
        row2.appendChild(sep);

        const op2Select = createOperatorSelect('scl-op2', cond2 ? cond2.op : '<');
        row2.appendChild(op2Select);
        const val2Input = document.createElement('input');
        val2Input.type = 'number';
        val2Input.step = '0.01';
        val2Input.className = 'scl-val2 form-control form-control-sm';
        val2Input.style.maxWidth = '80px';
        val2Input.placeholder = '%';
        if (cond2) val2Input.value = cond2.val;
        row2.appendChild(val2Input);
        row2.appendChild(document.createTextNode('%'));
        condsContainer.appendChild(row2);

        // Range Toggle (moved to end of flex container)
        const rangeDiv = document.createElement('div');
        rangeDiv.className = 'form-check text-sm d-flex align-items-center mb-0';

        const rangeCheck = document.createElement('input');
        rangeCheck.type = 'checkbox';
        rangeCheck.className = 'scl-range-check form-check-input mt-0';
        rangeCheck.id = 'range_check_' + Math.random().toString(36).substr(2, 9);
        rangeCheck.checked = !!cond2;

        const rangeLabel = document.createElement('label');
        rangeLabel.className = 'form-check-label ml-2';
        rangeLabel.setAttribute('for', rangeCheck.id);
        rangeLabel.textContent = 'Rozmez√≠';

        rangeDiv.appendChild(rangeCheck);
        rangeDiv.appendChild(rangeLabel);

        condsContainer.appendChild(rangeDiv);

        div.appendChild(condsContainer);

        rangeCheck.addEventListener('change', () => {
            row2.style.display = rangeCheck.checked ? 'flex' : 'none';
            serializeScls();
        });

        [selectHazard, op1Select, val1Input, op2Select, val2Input].forEach(el => {
            el.addEventListener('change', serializeScls);
            el.addEventListener('input', serializeScls);
        });

        sclContainer.appendChild(div);
    }

    function loadExistingScls() {
        if (sclDataInput.value) {
            const sclsArray = sclDataInput.value.split(',').map(s => s.trim()).filter(s => s);
            sclsArray.forEach(sclString => {
                if (sclString.includes(':')) {
                    const [hazard, condsStr] = sclString.split(':').map(s => s.trim());
                    const condsParts = condsStr.split(';').map(s => s.trim());
                    let c1 = { op: '>=', val: '' };
                    let c2 = null;
                    condsParts.forEach((cp, idx) => {
                        const match = cp.match(/^([>=<]+)\s*([\d\.]+)$/);
                        if (match) {
                            if (idx === 0) c1 = { op: match[1], val: match[2] };
                            else if (idx === 1) c2 = { op: match[1], val: match[2] };
                        }
                    });
                    createSclRow(hazard, c1, c2);
                } else if (sclString.includes('=')) {
                    const [hazard, limit] = sclString.split('=').map(s => s.trim());
                    createSclRow(hazard, { op: '>=', val: limit });
                }
            });
        }
        serializeScls();
    }

    loadExistingScls();
    addSclButton.addEventListener('click', () => createSclRow());

    // --- Unit Warnings & Conversion ---
    const unitPpmRadio = document.getElementById('unit_ppm');
    const unitMglRadio = document.getElementById('unit_mgl');
    const gasInput = document.getElementById('ate_inhalation_gases');
    const mwInput = document.getElementById('molecular_weight');
    const gasUnitDisplay = document.getElementById('gas_unit_display');
    const mglInfo = document.getElementById('mgl_conversion_info');
    const mwWarning = document.getElementById('mw_missing_warning');

    function updateGasUnitState() {
        const isMgl = unitMglRadio.checked;
        gasUnitDisplay.textContent = isMgl ? 'mg/l' : 'ppmV';
        mglInfo.style.display = isMgl ? 'block' : 'none';

        // Change step based on unit
        gasInput.step = isMgl ? '0.001' : '1';

        // Basic conversion attempt on switch? (Volatile UX, maybe skip for now and just clear or keep raw val)
        // Keeping raw value is safer, user just toggles how it's interpreted.

        checkUnitWarnings();
    }

    if (unitPpmRadio && unitMglRadio) {
        unitPpmRadio.addEventListener('change', updateGasUnitState);
        unitMglRadio.addEventListener('change', updateGasUnitState);
    }

    // Intercept form submission to convert if needed
    const form = document.getElementById('substance-form');
    form.addEventListener('submit', function (e) {
        if (unitMglRadio.checked && gasInput.value) {
            const mw = parseFloat(mwInput.value);
            const mgl = parseFloat(gasInput.value);

            if (!mw || mw <= 0) {
                e.preventDefault();
                mwWarning.style.display = 'block';
                mwInput.focus();
                mwInput.classList.add('is-invalid');
                return;
            }

            // Convert to PPM before sending
            // ppm = (mg/l * 24450) / MW (assuming 25 deg C, 1 atm -> Molar Vol approx 24.45 L)
            const ppm = (mgl * 24450) / mw;
            gasInput.value = Math.round(ppm);

            // Allow submit - the backend receives the PPM value
            // (Note: This mutates the user input visually before submit, which is accepted behavior here)
        }
    });

    function checkUnitWarnings() {
        const check = (id, threshold, type) => {
            const el = document.getElementById(id);
            if (!el) return;
            const val = parseFloat(el.value);
            const warn = document.getElementById(type);
            if (!warn) return;

            if (id === 'ate_inhalation_gases' && unitMglRadio.checked) {
                // If mg/l selected, warn if > 20 mg/l (approx Cat 4 limit for vapour, rough heuristic)
                warn.style.display = (!isNaN(val) && val > 20) ? 'block' : 'none';
                warn.textContent = '‚ö†Ô∏è Vysok√° hodnota (>20 mg/l)';
            } else if (type === 'warn_gases') {
                warn.style.display = (!isNaN(val) && val > 0 && val < threshold) ? 'block' : 'none';
                warn.textContent = '‚ö†Ô∏è N√≠zk√° hodnota (<100 ppm)';
            } else {
                warn.style.display = (!isNaN(val) && val > threshold) ? 'block' : 'none';
            }
        };
        check('ate_inhalation_vapours', 100, 'warn_vapours');
        check('ate_inhalation_dusts_mists', 100, 'warn_dusts');
        check('ate_inhalation_gases', 100, 'warn_gases');
    }

    ['ate_inhalation_vapours', 'ate_inhalation_dusts_mists', 'ate_inhalation_gases'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', checkUnitWarnings);
            el.addEventListener('change', checkUnitWarnings);
        }
    });

    // --- ECHA API Fetch Logic ---
    const btnFetchEcha = document.getElementById('btn_fetch_echa');
    const casInputNode = document.getElementById('cas_number');

    if (btnFetchEcha && casInputNode) {
        btnFetchEcha.addEventListener('click', async () => {
            const query = casInputNode.value.trim();
            if (!query) {
                alert('Zadejte pros√≠m CAS ƒç√≠slo.');
                return;
            }

            const originalHtml = btnFetchEcha.innerHTML;
            btnFetchEcha.disabled = true;
            btnFetchEcha.innerHTML = '‚åõ Naƒç√≠t√°m...';

            try {
                const response = await fetch('{{ url_for("substances.fetch_echa") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ form.csrf_token.current_token }}'
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Nepoda≈ôilo se z√≠skat data z ECHA.');
                }

                // 1. Z√°kladn√≠ info (jen pokud je pr√°zdn√©)
                const nameInput = document.getElementById('name');
                if (nameInput && !nameInput.value.trim()) {
                    nameInput.value = data.name;
                }

                // 2. Legislativn√≠ statusy
                const fieldMapping = {
                    'is_svhc': data.is_svhc,
                    'is_reach_annex_xiv': data.is_reach_annex_xiv,
                    'is_reach_annex_xvii': data.is_reach_annex_xvii,
                    'is_pbt': data.is_pbt,
                    'is_vpvb': data.is_vpvb,
                    'is_pmt': data.is_pmt,
                    'is_vpvm': data.is_vpvm
                };

                for (const [id, value] of Object.entries(fieldMapping)) {
                    const el = document.getElementById(id);
                    if (el) el.checked = value;
                }

                // 3. SCL (Specifick√© koncentraƒçn√≠ limity)
                if (data.scl_limits && data.scl_limits.length > 0) {
                    data.scl_limits.forEach(sclString => {
                        if (sclString.includes(':')) {
                            const [hazard, condsStr] = sclString.split(':').map(s => s.trim());
                            const condsParts = condsStr.split(';').map(s => s.trim());
                            let c1 = { op: '>=', val: '' };
                            let c2 = null;

                            condsParts.forEach((cp, idx) => {
                                const match = cp.match(/^([>=<]+)\s*([\d\.]+)$/);
                                if (match) {
                                    if (idx === 0) c1 = { op: match[1], val: match[2] };
                                    else if (idx === 1) c2 = { op: match[1], val: match[2] };
                                }
                            });

                            const currentSclVal = document.getElementById('scl_limits').value;
                            if (!currentSclVal.includes(sclString)) {
                                createSclRow(hazard, c1, c2);
                            }
                        }
                    });
                    serializeScls();
                }

                // 4. GHS Symboly (Piktogramy)
                if (data.ghs_symbols && data.ghs_symbols.length > 0) {
                    // Slouƒç√≠me s ji≈æ vybran√Ωmi (set pro unik√°tnost)
                    const existingGhs = ghsInput.value.split(',').map(s => s.trim()).filter(s => s);
                    const allGhs = [...new Set([...existingGhs, ...data.ghs_symbols])];
                    ghsInput.value = allGhs.join(', ');
                    renderGhsGrid();
                }

                // 5. H-Vƒõty
                if (data.h_phrases && data.h_phrases.length > 0) {
                    data.h_phrases.forEach(hCode => {
                        // Zdrav√≠
                        const hEl = document.getElementById('health_' + hCode);
                        if (hEl) hEl.checked = true;

                        // Prost≈ôed√≠
                        const eEl = document.getElementById('env_' + hCode);
                        if (eEl) eEl.checked = true;
                    });
                }

                // 6. ATE Hodnoty
                if (data.ate_values) {
                    const ateForms = {
                        'oral': 'ate_oral',
                        'dermal': 'ate_dermal',
                        'inhalation_gas': 'ate_inhalation_gases',
                        'inhalation_vapour': 'ate_inhalation_vapours'
                    };

                    for (const [key, fieldId] of Object.entries(ateForms)) {
                        const val = data.ate_values[key];
                        if (val !== undefined) {
                            const input = document.getElementById(fieldId);
                            if (input && !input.value) { // Vypln√≠me jen pokud je pr√°zdn√©
                                input.value = val;
                                // Pokud vypl≈àujeme plyn, zajist√≠me spr√°vnou jednotku
                                if (key === 'inhalation_gas') {
                                    const ppmRadio = document.getElementById('unit_ppm');
                                    if (ppmRadio) {
                                        ppmRadio.checked = true;
                                        updateGasUnitState();
                                    }
                                }
                            }
                        }
                    }
                    checkUnitWarnings();
                }

                btnFetchEcha.classList.remove('button-secondary');
                btnFetchEcha.classList.add('button-success');
                btnFetchEcha.innerHTML = '‚úÖ Hotovo';

                setTimeout(() => {
                    btnFetchEcha.classList.remove('button-success');
                    btnFetchEcha.classList.add('button-secondary');
                    btnFetchEcha.innerHTML = originalHtml;
                    btnFetchEcha.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('ECHA Fetch Error:', error);
                alert('Chyba: ' + error.message);
                btnFetchEcha.innerHTML = originalHtml;
                btnFetchEcha.disabled = false;
            }
        });
    }
</script>
{% endblock %}