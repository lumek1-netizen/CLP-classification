{% extends "base.html" %}

{% block content %}
<div class="container mt-5">

    {% if substance and substance.id %}
    <h1>üìù Editovat L√°tku: **{{ substance.name }}**</h1>
    {% else %}
    <h1>‚ûï P≈ôidat Novou L√°tku</h1>
    {% endif %}

    <hr>

    <form method="POST"
        action="{{ url_for('substances.edit', substance_id=substance.id) if substance and substance.id else url_for('substances.create') }}">
        {{ form.hidden_tag() }}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="form-card mb-4">
            <h3>üè∑Ô∏è Z√°kladn√≠ Identifikace</h3>

            <div class="group-grid">
                <div class="form-group">
                    <label for="name">N√°zev L√°tky <span class="text-danger">*</span></label>
                    {{ form.name(id="name", placeholder="Nap≈ô. Ethanol", required=True) }}
                    {% for error in form.name.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="cas_number">CAS ƒå√≠slo</label>
                    {{ form.cas_number(id="cas_number", placeholder="Nap≈ô. 64-17-5") }}
                    {% for error in form.cas_number.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group mt-3">
                <label for="ghs_codes">GHS K√≥dy (Piktogramy)</label>
                {{ form.ghs_codes(id="ghs_codes", placeholder="Nap≈ô. GHS02, GHS07 (oddƒõlte ƒç√°rkou)") }}
                {% for error in form.ghs_codes.errors %}
                <small class="text-danger">{{ error }}</small>
                {% endfor %}
            </div>
            <small class="hint mt-2">Zadejte GHS k√≥dy (piktogramy) oddƒõlen√© ƒç√°rkou, nap≈ô. GHS02, GHS07.</small>
        </div>


        <div class="form-card mb-4">
            <h3>‚öïÔ∏è H-Vƒõty (Zdrav√≠ Nebezpeƒç√≠)</h3>
            <div class="checkbox-group">
                {% for code, description in health_h_phrases.items() %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="health_h_phrases" value="{{ code }}"
                        id="health_{{ code }}" {% if code in selected_health_h_phrases %}checked{% endif %}>
                    <label class="form-check-label" for="health_{{ code }}">
                        <strong>{{ code }}</strong>: {{ description }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="form-card mb-4">
            <h3>üå≥ H-Vƒõty (≈Ωivotn√≠ Prost≈ôed√≠)</h3>
            <div class="checkbox-group">
                {% for code, description in env_h_phrases.items() %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="env_h_phrases" value="{{ code }}"
                        id="env_{{ code }}" {% if code in selected_env_h_phrases %}checked{% endif %}>
                    <label class="form-check-label" for="env_{{ code }}">
                        <strong>{{ code }}</strong>: {{ description }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="form-card mb-4">
            <h3>üß™ Akutn√≠ Toxicita (ATE Hodnoty - mg/kg nebo mg/l)</h3>
            <div class="group-grid">
                <div class="form-group">
                    <label for="ate_oral" class="label-with-tooltip">
                        ATE Or√°ln√≠ (mg/kg)
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                Akutn√≠ toxicita p≈ôi po≈æit√≠. Hodnota LD50 v mg/kg tƒõlesn√© hmotnosti. Ni≈æ≈°√≠ hodnota =
                                vy≈°≈°√≠ toxicita.
                            </span>
                        </span>
                    </label>
                    {{ form.ate_oral(id="ate_oral", step="0.01", min="0", placeholder="Nap≈ô. 300") }}
                    {% for error in form.ate_oral.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="ate_dermal" class="label-with-tooltip">
                        ATE Derm√°ln√≠ (mg/kg)
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                Akutn√≠ toxicita p≈ôi styku s k≈Ø≈æ√≠. Hodnota LD50 v mg/kg tƒõlesn√© hmotnosti.
                            </span>
                        </span>
                    </label>
                    {{ form.ate_dermal(id="ate_dermal", step="0.01", min="0", placeholder="Nap≈ô. 1100") }}
                    {% for error in form.ate_dermal.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_vapours">ATE Inhalaƒçn√≠ - P√°ry (mg/l)</label>
                    {{ form.ate_inhalation_vapours(id="ate_inhalation_vapours", step="0.01", min="0", placeholder="Nap≈ô.
                    15.0") }}
                    {% for error in form.ate_inhalation_vapours.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_dusts_mists">ATE Inhalaƒçn√≠ - Prach/Mlha (mg/l)</label>
                    {{ form.ate_inhalation_dusts_mists(id="ate_inhalation_dusts_mists", step="0.01", min="0",
                    placeholder="Nap≈ô. 0.8") }}
                    {% for error in form.ate_inhalation_dusts_mists.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_gases">ATE Inhalaƒçn√≠ - Plyny (ppm)</label>
                    {{ form.ate_inhalation_gases(id="ate_inhalation_gases", step="1", min="0", placeholder="Nap≈ô. 4500")
                    }}
                    {% for error in form.ate_inhalation_gases.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
            <small class="hint mt-2">Pou≈æ√≠vejte pouze ƒçist√© ƒç√≠seln√© hodnoty. Desetinn√° m√≠sta oddƒõlujte teƒçkou. Nechte
                pr√°zdn√©, pokud nen√≠ relevantn√≠.</small>
        </div>


        <div class="form-card mb-4">
            <h3>
                üß¨ M-Faktor (M-Factor)
                <span class="tooltip-wrapper">
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip-content">
                        Multiplikaƒçn√≠ faktor pro nebezpeƒçnost vodn√≠ch organism≈Ø. Pou≈æ√≠v√° se pro l√°tky s vysokou
                        toxicitou (Aquatic Acute 1 nebo Chronic 1).
                    </span>
                </span>
            </h3>
            <div class="group-grid">
                <div class="form-group">
                    <label for="m_factor_acute" class="label-with-tooltip">
                        M-Faktor Akutn√≠ (Acute 1)
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                Pro l√°tky s H400. Hodnoty: 1, 10, 100, 1000. Vy≈°≈°√≠ hodnota = vƒõt≈°√≠ multiplikace
                                koncentrace p≈ôi v√Ωpoƒçtu.
                            </span>
                        </span>
                    </label>
                    {{ form.m_factor_acute(id="m_factor_acute", step="1", min="1", placeholder="Nap≈ô. 10") }}
                    {% for error in form.m_factor_acute.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <label for="m_factor_chronic" class="label-with-tooltip">
                        M-Faktor Chronick√Ω (Chronic 1)
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                Pro l√°tky s H410. Hodnoty: 1, 10, 100, 1000. Vy≈°≈°√≠ hodnota = vƒõt≈°√≠ multiplikace
                                koncentrace p≈ôi v√Ωpoƒçtu.
                            </span>
                        </span>
                    </label>
                    {{ form.m_factor_chronic(id="m_factor_chronic", step="1", min="1", placeholder="Nap≈ô. 10") }}
                    {% for error in form.m_factor_chronic.errors %}
                    <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
            <small class="hint mt-2">Zadejte celoƒç√≠selnou hodnotu (nap≈ô. 1, 10, 100). Standardn√≠ hodnota je 1.</small>
        </div>



        <div class="form-card mb-4">
            <h3>üÜï Roz≈°√≠≈ôen√© Po≈æadavky 2026 (ED, PBT, Laktace)</h3>
            <div class="group-grid">
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.is_lact(id="is_lact") }} {{ form.is_lact.label.text }}
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.has_ozone(id="has_ozone") }} {{ form.has_ozone.label.text }}
                    </label>
                </div>
            </div>

            <div class="group-grid mt-3">
                <div class="form-group">
                    <label for="ed_hh_cat">{{ form.ed_hh_cat.label.text }}</label>
                    {{ form.ed_hh_cat(id="ed_hh_cat", class="form-control") }}
                </div>
                <div class="form-group">
                    <label for="ed_env_cat">{{ form.ed_env_cat.label.text }}</label>
                    {{ form.ed_env_cat(id="ed_env_cat", class="form-control") }}
                </div>
            </div>

            <div class="group-grid mt-3">
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.is_pbt(id="is_pbt") }} {{ form.is_pbt.label.text }}
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.is_vpvb(id="is_vpvb") }} {{ form.is_vpvb.label.text }}
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.is_pmt(id="is_pmt") }} {{ form.is_pmt.label.text }}
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-check-label d-flex align-items-center" style="gap: 10px;">
                        {{ form.is_vpvm(id="is_vpvm") }} {{ form.is_vpvm.label.text }}
                    </label>
                </div>
            </div>
            <small class="hint mt-2">Dle na≈ô√≠zen√≠ 2023/707 a legislativy platn√© k roku 2026.</small>
        </div>

        <div class="form-card mb-4">
            <h3>
                üìë Specifick√© Koncentraƒçn√≠ Limity (SCLs)
                <span class="tooltip-wrapper">
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip-content">
                        Specifick√© limity pro klasifikaci smƒõsi. Pou≈æ√≠vaj√≠ se m√≠sto standardn√≠ch limit≈Ø, pokud je l√°tka
                        zvl√°≈°tƒõ nebezpeƒçn√° nebo naopak m√©nƒõ nebezpeƒçn√°.
                    </span>
                </span>
            </h3>
            <div class="form-group" id="scl_form_group">
                <label for="scl_data">SCLs (nap≈ô. C ‚â• 5% nebo 5% ‚â§ C < 25%)</label>
                        <div id="scl_container" class="mt-2">
                        </div>
                        <button type="button" id="add_scl_button" class="button button-secondary button-small mt-2">‚ûï
                            P≈ôidat SCL</button>

                        {{ form.scl_limits(id="scl_limits") }}

                        <small class="hint mt-2">Kliknƒõte na "P≈ôidat SCL" pro definov√°n√≠ specifick√Ωch limit≈Ø (podporuje
                            oper√°tory >=, >, <=, < i rozmez√≠).</small>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('substances.index') }}" class="button">Zpƒõt na seznam l√°tek</a>

            <button type="submit" class="button button-primary">
                {% if substance and substance.id %}
                üíæ Ulo≈æit Zmƒõny L√°tky
                {% else %}
                ‚úÖ Vytvo≈ôit L√°tku
                {% endif %}
            </button>
        </div>

    </form>

    {% if audit_logs %}
    <div class="form-card mt-5 mb-4">
        <h3>üìú Historie zmƒõn</h3>
        <div class="table-responsive">
            <table class="data-list table-sm">
                <thead>
                    <tr>
                        <th style="width: 20%;">ƒåas</th>
                        <th style="width: 20%;">U≈æivatel</th>
                        <th style="width: 15%;">Akce</th>
                        <th style="width: 45%;">Detaily zmƒõn</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in audit_logs %}
                    <tr>
                        <td><small>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}</small></td>
                        <td>{{ log.user.username if log.user else 'Syst√©m' }}</td>
                        <td>
                            <span
                                class="badge {% if log.action == 'CREATE' %}badge-success{% elif log.action == 'UPDATE' %}badge-warning{% else %}badge-danger{% endif %}"
                                style="padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: white;">
                                {{ log.action }}
                            </span>
                        </td>
                        <td style="font-size: 0.85rem;">
                            {% if log.action == 'UPDATE' and log.changes %}
                            {% for field, diff in log.changes.items() %}
                            <div class="mb-1">
                                <code>{{ field }}</code>:
                                <span class="text-muted">{{ diff.old or 'N/A' }}</span> ‚û°Ô∏è
                                <span class="text-success">{{ diff.new or 'N/A' }}</span>
                            </div>
                            {% endfor %}
                            {% else %}
                            {{ log.action.capitalize() }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Z√≠sk√°n√≠ dat z Jinja kontextu
    const SCL_HAZARD_CATEGORIES = {{ scl_hazard_categories | tojson | safe }};

    const sclContainer = document.getElementById('scl_container');
    const addSclButton = document.getElementById('add_scl_button');
    const sclDataInput = document.getElementById('scl_limits'); // Skryt√© pole pro fin√°ln√≠ string

    // 1. Funkce pro serializaci SCL formul√°≈ô≈Ø na fin√°ln√≠ string
    function serializeScls() {
        const rows = sclContainer.querySelectorAll('.scl-row');
        const scls = [];

        rows.forEach(row => {
            const hazard = row.querySelector('.scl-hazard').value;
            if (!hazard) return;

            const conds = [];

            // Prvn√≠ podm√≠nka
            const op1 = row.querySelector('.scl-op1').value;
            const val1 = row.querySelector('.scl-val1').value;
            if (op1 && val1 && !isNaN(parseFloat(val1))) {
                conds.push(`${op1} ${parseFloat(val1)}`);
            }

            // Druh√° podm√≠nka (pokud je aktivn√≠ rozmez√≠)
            const rangeCheck = row.querySelector('.scl-range-check');
            if (rangeCheck && rangeCheck.checked) {
                const op2 = row.querySelector('.scl-op2').value;
                const val2 = row.querySelector('.scl-val2').value;
                if (op2 && val2 && !isNaN(parseFloat(val2))) {
                    conds.push(`${op2} ${parseFloat(val2)}`);
                }
            }

            if (conds.length > 0) {
                // Sestav√≠me form√°t: Hazard: op1 val1; op2 val2
                scls.push(`${hazard}: ${conds.join('; ')}`);
            }
        });

        // Ulo≈æen√≠ do skryt√©ho pole pro odesl√°n√≠ do Flasku
        sclDataInput.value = scls.join(', ');
    }

    // Pomocn√° funkce pro vytvo≈ôen√≠ selectu oper√°toru
    function createOperatorSelect(className, defaultValue = '>=') {
        const select = document.createElement('select');
        select.className = `${className} form-control`;
        select.style.minWidth = '60px';
        const ops = ['>=', '>', '<=', '<'];
        ops.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op;
            opt.textContent = op;
            if (op === defaultValue) opt.selected = true;
            select.appendChild(opt);
        });
        return select;
    }

    // 2. Funkce pro vytvo≈ôen√≠ jednoho ≈ô√°dku SCL
    function createSclRow(defaultHazard = '', cond1 = { op: '>=', val: '' }, cond2 = null) {
        const div = document.createElement('div');
        div.className = 'scl-row card p-3 mb-3';
        div.style.border = '1px solid #ddd';
        div.style.backgroundColor = '#f9f9f9';

        const topRow = document.createElement('div');
        topRow.className = 'd-flex justify-content-between align-items-center mb-2';

        const hazardHeading = document.createElement('strong');
        hazardHeading.textContent = 'Kategorie nebezpeƒçnosti:';
        topRow.appendChild(hazardHeading);

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'button button-delete button-small';
        removeButton.textContent = '‚úñ Odstranit';
        removeButton.addEventListener('click', () => {
            div.remove();
            serializeScls();
        });
        topRow.appendChild(removeButton);
        div.appendChild(topRow);

        // Select pro hazard
        const selectHazard = document.createElement('select');
        selectHazard.className = 'scl-hazard form-control mb-3';

        let initialOption = document.createElement('option');
        initialOption.value = '';
        initialOption.textContent = 'Vyberte nebezpeƒç√≠...';
        selectHazard.appendChild(initialOption);

        SCL_HAZARD_CATEGORIES.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            if (category === defaultHazard) option.selected = true;
            selectHazard.appendChild(option);
        });
        div.appendChild(selectHazard);

        // Podm√≠nky
        const condsContainer = document.createElement('div');
        condsContainer.className = 'conds-container';

        // ≈ò√°dek 1
        const row1 = document.createElement('div');
        row1.className = 'd-flex align-items-center mb-2';
        row1.style.gap = '10px';

        row1.appendChild(document.createTextNode('Koncentrace (C) '));
        const op1Select = createOperatorSelect('scl-op1', cond1.op);
        row1.appendChild(op1Select);

        const val1Input = document.createElement('input');
        val1Input.type = 'number';
        val1Input.step = '0.01';
        val1Input.className = 'scl-val1 form-control';
        val1Input.placeholder = 'Limit %';
        val1Input.value = cond1.val;
        row1.appendChild(val1Input);
        row1.appendChild(document.createTextNode(' %'));

        condsContainer.appendChild(row1);

        // Range checkbox
        const rangeDiv = document.createElement('div');
        rangeDiv.className = 'mb-2';
        const rangeLabel = document.createElement('label');
        rangeLabel.style.fontWeight = 'normal';
        rangeLabel.style.cursor = 'pointer';

        const rangeCheck = document.createElement('input');
        rangeCheck.type = 'checkbox';
        rangeCheck.className = 'scl-range-check mr-2';
        rangeCheck.checked = !!cond2;
        rangeLabel.appendChild(rangeCheck);
        rangeLabel.appendChild(document.createTextNode(' P≈ôidat druhou podm√≠nku (rozmez√≠)'));
        rangeDiv.appendChild(rangeLabel);
        condsContainer.appendChild(rangeDiv);

        // ≈ò√°dek 2 (voliteln√Ω)
        const row2 = document.createElement('div');
        row2.className = 'scl-row2 d-flex align-items-center mb-2';
        row2.style.gap = '10px';
        row2.style.display = cond2 ? 'flex' : 'none';

        row2.appendChild(document.createTextNode('A z√°rove≈à (C) '));
        const op2Select = createOperatorSelect('scl-op2', cond2 ? cond2.op : '<');
        row2.appendChild(op2Select);

        const val2Input = document.createElement('input');
        val2Input.type = 'number';
        val2Input.step = '0.01';
        val2Input.className = 'scl-val2 form-control';
        val2Input.placeholder = 'Limit %';
        if (cond2) val2Input.value = cond2.val;
        row2.appendChild(val2Input);
        row2.appendChild(document.createTextNode(' %'));

        condsContainer.appendChild(row2);
        div.appendChild(condsContainer);

        // Event listener pro range checkbox
        rangeCheck.addEventListener('change', () => {
            row2.style.display = rangeCheck.checked ? 'flex' : 'none';
            serializeScls();
        });

        // Event listeners pro aktualizaci
        [selectHazard, op1Select, val1Input, op2Select, val2Input].forEach(el => {
            el.addEventListener('change', serializeScls);
            el.addEventListener('input', serializeScls);
        });

        sclContainer.appendChild(div);
    }

    // 3. Naƒçten√≠ existuj√≠c√≠ch SCLs p≈ôi naƒçten√≠ str√°nky (pro Editaci)
    function loadExistingScls() {
        if (sclDataInput.value) {
            const sclsArray = sclDataInput.value.split(',').map(s => s.trim()).filter(s => s);

            sclsArray.forEach(sclString => {
                // Nov√Ω form√°t: "Hazard: op1 val1; op2 val2"
                if (sclString.includes(':')) {
                    const [hazard, condsStr] = sclString.split(':').map(s => s.trim());
                    const condsParts = condsStr.split(';').map(s => s.trim());

                    let c1 = { op: '>=', val: '' };
                    let c2 = null;

                    condsParts.forEach((cp, idx) => {
                        const match = cp.match(/^([>=<]+)\s*([\d\.]+)$/);
                        if (match) {
                            if (idx === 0) {
                                c1 = { op: match[1], val: match[2] };
                            } else if (idx === 1) {
                                c2 = { op: match[1], val: match[2] };
                            }
                        }
                    });
                    createSclRow(hazard, c1, c2);
                } else if (sclString.includes('=')) {
                    // Star√Ω form√°t: "Hazard=Limit"
                    const [hazard, limit] = sclString.split('=').map(s => s.trim());
                    createSclRow(hazard, { op: '>=', val: limit });
                }
            });
        }
        serializeScls();
    }

    // 4. Inicializace
    loadExistingScls();

    // Listener pro tlaƒç√≠tko "P≈ôidat SCL"
    addSclButton.addEventListener('click', () => {
        createSclRow();
    });

</script>

{% endblock %}