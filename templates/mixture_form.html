{% extends "base.html" %}

{% block title %}
{% if mixture %}Editovat Smƒõs: {{ mixture.name }}{% else %}Vytvo≈ôit Novou Smƒõs{% endif %}
{% endblock %}

{% block content %}
<!-- Page Header (Sticky) -->
<div class="page-header">
    <div class="page-header__content">
        <div class="page-title-group">
            <div class="breadcrumbs">
                <a href="{{ url_for('mixtures.index') }}" class="text-muted" style="text-decoration: none;">Smƒõsi</a>
                <span class="text-secondary">/</span>
                <span>{{ 'Editace' if mixture else 'Nov√°' }}</span>
            </div>
            <h1 class="page-title">
                {% if mixture %}Editovat: {{ mixture.name }}{% else %}Nov√° Smƒõs{% endif %}
            </h1>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('mixtures.index') }}" class="button button-secondary">Zru≈°it</a>
            <button type="submit" form="mixture-form" class="button button-primary">
                {{ 'üíæ Ulo≈æit Zmƒõny' if mixture else '‚úÖ Vytvo≈ôit Smƒõs' }}
            </button>
        </div>
    </div>
</div>

<div class="container">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" id="mixture-form"
        action="{% if mixture %}{{ url_for('mixtures.edit', mixture_id=mixture.id) }}{% else %}{{ url_for('mixtures.create') }}{% endif %}">
        {{ form.hidden_tag() }}

        <div class="grid-dashboard">
            <!-- Main Column -->
            <div class="col-main">

                <!-- 1. Basic Info Card -->
                <section class="card mb-6">
                    <div class="card__header">
                        <h2 class="card__title">üè∑Ô∏è Z√°kladn√≠ Informace</h2>
                    </div>
                    <div class="card__body">
                        <div class="form-group mb-4">
                            <label for="name" class="font-bold mb-1 d-block">N√°zev Smƒõsi <span
                                    class="text-danger">*</span></label>
                            {{ form.name(id="name", class="form-control", placeholder="Nap≈ô. ƒåist√≠c√≠ prost≈ôedek XYZ",
                            required=True) }}
                            {% for error in form.name.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="form-group mb-4">
                            <label for="user_type" class="font-bold mb-1 d-block">{{ form.user_type.label }}
                                <span class="text-danger">*</span></label>
                            {{ form.user_type(class="form-control", id="user_type") }}
                            <small class="text-muted">{{ form.user_type.description }}</small>
                            {% for error in form.user_type.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="form-group mb-4">
                            <label for="physical_state" class="font-bold mb-1 d-block">{{ form.physical_state.label }}
                                <span class="text-danger">*</span></label>
                            {{ form.physical_state(class="form-control", id="physical_state") }}
                            {% for error in form.physical_state.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="row" id="liquid-properties" style="display: none;">
                            <div class="col-md-6 form-group mb-4">
                                <label for="flash_point" class="font-bold mb-1 d-block">{{ form.flash_point.label
                                    }}</label>
                                {{ form.flash_point(class="form-control", id="flash_point", placeholder="nap≈ô. 23.0") }}
                                <small class="text-muted">{{ form.flash_point.description }}</small>
                            </div>
                            <div class="col-md-6 form-group mb-4">
                                <label for="boiling_point" class="font-bold mb-1 d-block">{{ form.boiling_point.label
                                    }}</label>
                                {{ form.boiling_point(class="form-control", id="boiling_point", placeholder="nap≈ô.
                                78.0") }}
                                <small class="text-muted">{{ form.boiling_point.description }}</small>
                            </div>
                            <div class="col-12 form-group mb-4">
                                <div class="form-check">
                                    {{ form.can_generate_mist(class="form-check-input", id="can_generate_mist") }}
                                    <label class="form-check-label font-bold" for="can_generate_mist">
                                        {{ form.can_generate_mist.label }}
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">{{ form.can_generate_mist.description }}</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="ph" class="font-bold mb-1 d-block">{{ form.ph.label }}</label>
                            {{ form.ph(class="form-control", id="ph", placeholder="Nap≈ô. 7.0") }}
                            <small class="text-muted text-sm mt-1 d-block">{{ form.ph.description }}</small>
                            {% for error in form.ph.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>
                    </div>
                </section>

                <!-- 2. Components Card -->
                <section class="card">
                    <div class="card__header justify-content-between">
                        <h2 class="card__title">üß™ Slo≈æen√≠ Smƒõsi</h2>
                        <button type="button" id="add-component-button" class="button button-secondary button-small">
                            ‚ûï P≈ôidat Slo≈æku
                        </button>
                    </div>
                    <div class="card__body">

                        <!-- Header Row -->
                        <div class="d-grid gap-4 mb-2 text-muted text-sm font-bold px-2"
                            style="grid-template-columns: 2fr 1fr 40px;">
                            <div>L√°tka</div>
                            <div>Koncentrace (%)</div>
                            <div></div>
                        </div>

                        <div id="components-container" class="d-flex flex-column gap-2">
                            <!-- Rows will be added here by JS -->
                        </div>

                        <div class="mt-4 p-4 bg-secondary rounded border border-color text-sm text-secondary">
                            <p class="mb-0">‚ÑπÔ∏è <strong>Tip:</strong> Celkov√° koncentrace by nemƒõla p≈ôes√°hnout 100 %.
                                Automatick√Ω v√Ωpoƒçet ATE probƒõhne po ulo≈æen√≠.</p>
                        </div>
                    </div>
                </section>

            </div>

            <!-- Sidebar Column (Optional help or summary) -->
            <aside class="col-sidebar">
                <div class="card bg-secondary">
                    <div class="card__body">
                        <h3 class="text-lg font-bold mb-2">N√°povƒõda</h3>
                        <p class="text-sm text-muted mb-4">
                            Pro spr√°vnou klasifikaci je nutn√© zadat p≈ôesn√© slo≈æen√≠. Vyberte l√°tky z datab√°ze a zadejte
                            jejich koncentraci.
                        </p>
                        <hr class="mb-4">
                        <h4 class="text-sm font-bold mb-2">Chyb√≠ l√°tka?</h4>
                        <a href="{{ url_for('substances.create') }}" target="_blank"
                            class="button button-outline text-sm w-100 mb-2">
                            Vytvo≈ôit novou l√°tku
                        </a>
                        <small class="text-xs text-muted">Otev≈ôe se v nov√©m oknƒõ. Po vytvo≈ôen√≠ obnovte tuto
                            str√°nku.</small>
                    </div>
                </div>
            </aside>
        </div>
    </form>
</div>

<script>
    const ALL_SUBSTANCES = {{ substances | tojson }};
    const EXISTING_COMPONENTS = {{ existing_components | tojson }};

    const componentsContainer = document.getElementById('components-container');
    const addComponentButton = document.getElementById('add-component-button');
    let componentCount = 0;

    function createSubstanceSelect(selectedValue = null) {
        const select = document.createElement('select');
        select.name = 'substance_id';
        select.required = true;
        select.classList.add('form-control');

        let defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- Vyberte l√°tku ---';
        defaultOption.disabled = true;
        select.appendChild(defaultOption);

        ALL_SUBSTANCES.forEach(substance => {
            const option = document.createElement('option');
            option.value = substance.id;
            option.textContent = `${substance.name} (ID: ${substance.id})`;
            if (selectedValue !== null && String(substance.id) === String(selectedValue)) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        if (selectedValue === null) defaultOption.selected = true;
        return select;
    }

    function addComponentRow(substanceId = null, concentration = null) {
        componentCount++;

        const rowDiv = document.createElement('div');
        rowDiv.classList.add('component-row', 'd-grid', 'gap-4', 'align-items-center');
        rowDiv.style.gridTemplateColumns = '2fr 1fr 40px'; // Matching header
        rowDiv.dataset.id = componentCount;

        // 1. Column: Substance Select
        const selectGroup = document.createElement('div');
        const select = createSubstanceSelect(substanceId);
        selectGroup.appendChild(select);

        // 2. Column: Concentration Input
        const concentrationGroup = document.createElement('div');
        const input = document.createElement('input');
        input.type = 'number';
        input.name = 'concentration';
        input.required = true;
        input.min = '0.001';
        input.step = '0.001';
        input.placeholder = 'Konc. %';
        input.classList.add('form-control');
        if (concentration !== null) input.value = parseFloat(concentration).toFixed(3);
        concentrationGroup.appendChild(input);

        // 3. Column: Delete Button
        const deleteGroup = document.createElement('div');
        deleteGroup.classList.add('d-flex', 'justify-content-end');

        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.innerHTML = '‚úñÔ∏è';
        deleteButton.title = 'Odstranit slo≈æku';
        deleteButton.classList.add('button', 'button-text', 'text-danger', 'p-0');
        deleteButton.style.fontSize = '1.2rem';

        deleteButton.addEventListener('click', () => {
            if (componentsContainer.querySelectorAll('.component-row').length > 1) {
                rowDiv.remove();
            } else {
                alert('Smƒõs mus√≠ obsahovat alespo≈à jednu slo≈æku.');
            }
        });
        deleteGroup.appendChild(deleteButton);

        rowDiv.appendChild(selectGroup);
        rowDiv.appendChild(concentrationGroup);
        rowDiv.appendChild(deleteGroup);
        componentsContainer.appendChild(rowDiv);
    }

    function loadExistingComponents() {
        if (EXISTING_COMPONENTS && EXISTING_COMPONENTS.length > 0) {
            EXISTING_COMPONENTS.forEach(comp => {
                addComponentRow(comp.substance_id, comp.concentration);
            });
        }
        if (!EXISTING_COMPONENTS || EXISTING_COMPONENTS.length === 0) {
            addComponentRow();
        }
    }

    document.addEventListener('DOMContentLoaded', loadExistingComponents);
    addComponentButton.addEventListener('click', () => addComponentRow());

    // Toggle Liquid Properties
    const physicalStateSelect = document.getElementById('physical_state');
    const liquidPropsDiv = document.getElementById('liquid-properties');

    function toggleLiquidProps() {
        if (physicalStateSelect.value === 'liquid') {
            liquidPropsDiv.style.display = 'flex';
        } else {
            liquidPropsDiv.style.display = 'none';
        }
    }

    physicalStateSelect.addEventListener('change', toggleLiquidProps);
    // Init on load
    toggleLiquidProps();

</script>
{% endblock %}