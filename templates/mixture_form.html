{% extends "base.html" %}

{% block title %}
{% if mixture %}Editovat Smƒõs: {{ mixture.name }}{% else %}Vytvo≈ôit Novou Smƒõs{% endif %}
{% endblock %}

{% block content %}
<!-- Page Header (Sticky) -->
<div class="page-header">
    <div class="page-header__content">
        <div class="page-title-group">
            <div class="breadcrumbs">
                <a href="{{ url_for('mixtures.index') }}" class="text-muted" style="text-decoration: none;">Smƒõsi</a>
                <span class="text-secondary">/</span>
                <span>{{ 'Editace' if mixture else 'Nov√°' }}</span>
            </div>
            <h1 class="page-title">
                {% if mixture %}Editovat: {{ mixture.name }}{% else %}Nov√° Smƒõs{% endif %}
            </h1>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('mixtures.index') }}" class="button button-secondary">Zru≈°it</a>
            <button type="submit" form="mixture-form" class="button button-primary">
                {{ 'üíæ Ulo≈æit Zmƒõny' if mixture else '‚úÖ Vytvo≈ôit Smƒõs' }}
            </button>
        </div>
    </div>
</div>

<div class="container">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" id="mixture-form"
        action="{% if mixture %}{{ url_for('mixtures.edit', mixture_id=mixture.id) }}{% else %}{{ url_for('mixtures.create') }}{% endif %}">
        {{ form.hidden_tag() }}

        <div class="grid-dashboard">
            <!-- Main Column -->
            <div class="col-main">

                <!-- 1. Basic Info Card -->
                <section class="card mb-6">
                    <div class="card__header">
                        <h2 class="card__title">üè∑Ô∏è Z√°kladn√≠ Informace</h2>
                    </div>
                    <div class="card__body">
                        <div class="form-group mb-4">
                            <label for="name" class="font-bold mb-1 d-block">N√°zev Smƒõsi <span
                                    class="text-danger">*</span></label>
                            {{ form.name(id="name", class="form-control", placeholder="Nap≈ô. ƒåist√≠c√≠ prost≈ôedek XYZ",
                            required=True) }}
                            {% for error in form.name.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="form-group mb-4">
                            <label for="user_type" class="font-bold mb-1 d-block">{{ form.user_type.label }}
                                <span class="text-danger">*</span></label>
                            {{ form.user_type(class="form-control", id="user_type") }}
                            <small class="text-muted">{{ form.user_type.description }}</small>
                            {% for error in form.user_type.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="form-group mb-4">
                            <label for="physical_state" class="font-bold mb-1 d-block">{{ form.physical_state.label }}
                                <span class="text-danger">*</span></label>
                            {{ form.physical_state(class="form-control", id="physical_state") }}
                            {% for error in form.physical_state.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>

                        <div class="row" id="liquid-properties" style="display: none;">
                            <div class="col-md-6 form-group mb-4">
                                <label for="flash_point" class="font-bold mb-1 d-block">{{ form.flash_point.label
                                    }}</label>
                                {{ form.flash_point(class="form-control", id="flash_point", placeholder="nap≈ô. 23.0") }}
                                <small class="text-muted">{{ form.flash_point.description }}</small>
                            </div>
                            <div class="col-md-6 form-group mb-4">
                                <label for="boiling_point" class="font-bold mb-1 d-block">{{ form.boiling_point.label
                                    }}</label>
                                {{ form.boiling_point(class="form-control", id="boiling_point", placeholder="nap≈ô.
                                78.0") }}
                                <small class="text-muted">{{ form.boiling_point.description }}</small>
                            </div>
                            <div class="col-12 form-group mb-4">
                                <div class="form-check">
                                    {{ form.can_generate_mist(class="form-check-input", id="can_generate_mist") }}
                                    <label class="form-check-label font-bold" for="can_generate_mist">
                                        {{ form.can_generate_mist.label }}
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">{{ form.can_generate_mist.description }}</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="ph" class="font-bold mb-1 d-block">{{ form.ph.label }}</label>
                            {{ form.ph(class="form-control", id="ph", placeholder="Nap≈ô. 7.0") }}
                            <small class="text-muted text-sm mt-1 d-block">{{ form.ph.description }}</small>
                            {% for error in form.ph.errors %}
                            <small class="text-danger">{{ error }}</small>
                            {% endfor %}
                        </div>
                    </div>
                </section>

                <!-- 2. Components Card -->
                <section class="card">
                    <div class="card__header justify-content-between">
                        <h2 class="card__title">üß™ Slo≈æen√≠ Smƒõsi</h2>
                        <button type="button" id="add-component-button" class="button button-secondary button-small">
                            ‚ûï P≈ôidat Slo≈æku
                        </button>
                    </div>
                    <div class="card__body">

                        <!-- Header Row -->
                        <div class="d-grid gap-4 mb-2 text-muted text-sm font-bold px-2"
                            style="grid-template-columns: 2fr 1fr 40px;">
                            <div>L√°tka</div>
                            <div>Koncentrace (%)</div>
                            <div></div>
                        </div>

                        <div id="components-container" class="d-flex flex-column gap-2">
                            <!-- Rows will be added here by JS -->
                        </div>

                        <div class="mt-4 p-4 bg-secondary rounded border border-color text-sm text-secondary">
                            <p class="mb-0">‚ÑπÔ∏è <strong>Tip:</strong> Celkov√° koncentrace by nemƒõla p≈ôes√°hnout 100 %.
                                Automatick√Ω v√Ωpoƒçet ATE probƒõhne po ulo≈æen√≠.</p>
                        </div>
                    </div>
                </section>

            </div>

            <!-- Sidebar Column (Optional help or summary) -->
            <aside class="col-sidebar">
                <div class="card bg-secondary">
                    <div class="card__body">
                        <h3 class="text-lg font-bold mb-2">N√°povƒõda</h3>
                        <p class="text-sm text-muted mb-4">
                            Pro spr√°vnou klasifikaci je nutn√© zadat p≈ôesn√© slo≈æen√≠. Vyberte l√°tky z datab√°ze a zadejte
                            jejich koncentraci.
                        </p>
                        <hr class="mb-4">
                        <h4 class="text-sm font-bold mb-2">Chyb√≠ l√°tka?</h4>
                        <a href="{{ url_for('substances.create') }}" target="_blank"
                            class="button button-outline text-sm w-100 mb-2">
                            Vytvo≈ôit novou l√°tku
                        </a>
                        <small class="text-xs text-muted">Otev≈ôe se v nov√©m oknƒõ. Po vytvo≈ôen√≠ obnovte tuto
                            str√°nku.</small>
                    </div>
                </div>
            </aside>
        </div>
    </form>
</div>

<script>
    const ALL_SUBSTANCES = {{ substances | tojson }};
    const ALL_MIXTURES = {{ mixtures | tojson }};
    const EXISTING_COMPONENTS = {{ existing_components | tojson }};

    const componentsContainer = document.getElementById('components-container');
    const addComponentButton = document.getElementById('add-component-button');
    let componentCount = 0;

    function createSearchableComponentInput(componentType = 'substance', selectedId = null) {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.width = '100%';

        // Skryt√Ω input pro component_type
        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'component_type';
        typeInput.value = componentType;
        container.appendChild(typeInput);

        // Skryt√Ω input pro substance_id
        const subIdInput = document.createElement('input');
        subIdInput.type = 'hidden';
        subIdInput.name = 'substance_id';
        subIdInput.value = (componentType === 'substance' && selectedId) ? selectedId : '';
        container.appendChild(subIdInput);

        // Skryt√Ω input pro mixture_id
        const mixIdInput = document.createElement('input');
        mixIdInput.type = 'hidden';
        mixIdInput.name = 'mixture_id';
        mixIdInput.value = (componentType === 'mixture' && selectedId) ? selectedId : '';
        container.appendChild(mixIdInput);

        // Viditeln√Ω input pro vyhled√°v√°n√≠
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.classList.add('form-control');
        searchInput.placeholder = 'Zaƒçnƒõte ps√°t n√°zev nebo CAS...';
        searchInput.autocomplete = 'off';

        // Dropdown pro v√Ωsledky
        const dropdown = document.createElement('div');
        dropdown.style.position = 'absolute';
        dropdown.style.top = '100%';
        dropdown.style.left = '0';
        dropdown.style.right = '0';
        dropdown.style.maxHeight = '200px';
        dropdown.style.overflowY = 'auto';
        dropdown.style.backgroundColor = 'white';
        dropdown.style.border = '1px solid #ccc';
        dropdown.style.borderRadius = '4px';
        dropdown.style.display = 'none';
        dropdown.style.zIndex = '1000';
        dropdown.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

        // Nastavit poƒç√°teƒçn√≠ hodnotu
        if (selectedId) {
            const items = componentType === 'substance' ? ALL_SUBSTANCES : ALL_MIXTURES;
            const selected = items.find(item => item.id == selectedId);
            if (selected) {
                if (componentType === 'substance') {
                    searchInput.value = `${selected.name}${selected.cas_number ? ' (' + selected.cas_number + ')' : ''}`;
                } else {
                    searchInput.value = `[Smƒõs] ${selected.name}`;
                }
            }
        }

        // Funkce pro filtrov√°n√≠ a zobrazen√≠ v√Ωsledk≈Ø
        function showResults(query) {
            dropdown.innerHTML = '';

            if (!query || query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            const lowerQuery = query.toLowerCase();
            let results = [];

            // Vyhledat v l√°tk√°ch
            const substanceResults = ALL_SUBSTANCES.filter(s =>
                s.name.toLowerCase().includes(lowerQuery) ||
                (s.cas_number && s.cas_number.includes(lowerQuery))
            ).slice(0, 10).map(s => ({
                type: 'substance',
                id: s.id,
                name: s.name,
                cas: s.cas_number,
                display: `${s.name}${s.cas_number ? ' (' + s.cas_number + ')' : ''}`
            }));

            // Vyhledat ve smƒõs√≠ch
            const mixtureResults = ALL_MIXTURES.filter(m =>
                m.name.toLowerCase().includes(lowerQuery)
            ).slice(0, 5).map(m => ({
                type: 'mixture',
                id: m.id,
                name: m.name,
                display: `[Smƒõs] ${m.name}`
            }));

            results = [...substanceResults, ...mixtureResults];

            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.style.padding = '8px 12px';
                noResults.style.color = '#999';
                noResults.textContent = '≈Ω√°dn√© v√Ωsledky';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
                return;
            }

            results.forEach(result => {
                const item = document.createElement('div');
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #eee';
                item.textContent = result.display;

                if (result.type === 'mixture') {
                    item.style.backgroundColor = '#f0f8ff';
                    item.style.fontWeight = '500';
                }

                item.addEventListener('mouseenter', () => {
                    item.style.backgroundColor = result.type === 'mixture' ? '#e0f0ff' : '#f5f5f5';
                });

                item.addEventListener('mouseleave', () => {
                    item.style.backgroundColor = result.type === 'mixture' ? '#f0f8ff' : 'white';
                });

                item.addEventListener('click', () => {
                    searchInput.value = result.display;
                    typeInput.value = result.type;
                    if (result.type === 'substance') {
                        subIdInput.value = result.id;
                        mixIdInput.value = '';
                    } else {
                        mixIdInput.value = result.id;
                        subIdInput.value = '';
                    }
                    dropdown.style.display = 'none';
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        searchInput.addEventListener('input', (e) => {
            showResults(e.target.value);
        });

        searchInput.addEventListener('focus', (e) => {
            if (e.target.value.length >= 2) {
                showResults(e.target.value);
            }
        });

        // Zav≈ô√≠t dropdown p≈ôi kliknut√≠ mimo
        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        container.appendChild(searchInput);
        container.appendChild(dropdown);

        return container;
    }

    function addComponentRow(componentType = 'substance', componentId = null, concentration = null) {
        componentCount++;

        const rowDiv = document.createElement('div');
        rowDiv.classList.add('component-row', 'd-grid', 'gap-4', 'align-items-center');
        rowDiv.style.gridTemplateColumns = '2fr 1fr 40px';
        rowDiv.dataset.id = componentCount;

        // 1. Column: Searchable Component Input
        const selectGroup = document.createElement('div');
        const searchableInput = createSearchableComponentInput(componentType, componentId);
        selectGroup.appendChild(searchableInput);

        // 2. Column: Concentration Input
        const concentrationGroup = document.createElement('div');
        const input = document.createElement('input');
        input.type = 'number';
        input.name = 'concentration';
        input.required = true;
        input.min = '0.001';
        input.step = '0.001';
        input.placeholder = 'Konc. %';
        input.classList.add('form-control');
        if (concentration !== null) input.value = parseFloat(concentration).toFixed(3);
        concentrationGroup.appendChild(input);

        // 3. Column: Delete Button
        const deleteGroup = document.createElement('div');
        deleteGroup.classList.add('d-flex', 'justify-content-end');

        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.innerHTML = '‚úñÔ∏è';
        deleteButton.title = 'Odstranit slo≈æku';
        deleteButton.classList.add('button', 'button-text', 'text-danger', 'p-0');
        deleteButton.style.fontSize = '1.2rem';

        deleteButton.addEventListener('click', () => {
            if (componentsContainer.querySelectorAll('.component-row').length > 1) {
                rowDiv.remove();
            } else {
                alert('Smƒõs mus√≠ obsahovat alespo≈à jednu slo≈æku.');
            }
        });
        deleteGroup.appendChild(deleteButton);

        rowDiv.appendChild(selectGroup);
        rowDiv.appendChild(concentrationGroup);
        rowDiv.appendChild(deleteGroup);
        componentsContainer.appendChild(rowDiv);
    }

    function loadExistingComponents() {
        if (EXISTING_COMPONENTS && EXISTING_COMPONENTS.length > 0) {
            EXISTING_COMPONENTS.forEach(comp => {
                const compType = comp.component_type || 'substance';
                const compId = compType === 'substance' ? comp.substance_id : comp.mixture_id;
                addComponentRow(compType, compId, comp.concentration);
            });
        }
        if (!EXISTING_COMPONENTS || EXISTING_COMPONENTS.length === 0) {
            addComponentRow();
        }
    }

    document.addEventListener('DOMContentLoaded', loadExistingComponents);
    addComponentButton.addEventListener('click', () => addComponentRow());

    // Toggle Liquid Properties
    const physicalStateSelect = document.getElementById('physical_state');
    const liquidPropsDiv = document.getElementById('liquid-properties');

    function toggleLiquidProps() {
        if (physicalStateSelect.value === 'liquid') {
            liquidPropsDiv.style.display = 'flex';
        } else {
            liquidPropsDiv.style.display = 'none';
        }
    }

    physicalStateSelect.addEventListener('change', toggleLiquidProps);
    // Init on load
    toggleLiquidProps();

</script>
{% endblock %}