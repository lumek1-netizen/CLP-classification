{% extends "base.html" %}

{% block title %}Detail: {{ mixture.name }}{% endblock %}

{% block content %}
<!-- Page Header (Sticky) -->
<div class="page-header no-print">
    <div class="page-header__content">
        <div class="page-title-group">
            <div class="breadcrumbs">
                <a href="{{ url_for('mixtures.index') }}" class="text-muted" style="text-decoration: none;">Smƒõsi</a>
                <span class="text-secondary">/</span> Detail
            </div>
            <h1 class="page-title">{{ mixture.name }}</h1>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('mixtures.index') }}" class="button button-secondary button-small">Zpƒõt</a>
            <button onclick="window.print()" class="button button-secondary button-small">üñ®Ô∏è Tisk</button>
            <a href="{{ url_for('mixtures.edit', mixture_id=mixture.id) }}" class="button button-primary">‚úèÔ∏è Upravit
                smƒõs</a>
        </div>
    </div>
</div>

<div class="container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="report-header only-print">
        <h1 class="print-title">Klasifikaƒçn√≠ Protokol: {{ mixture.name }}</h1>
        <p>Datum: {{ mixture.created_date.strftime('%d.%m.%Y') }} | ID: {{ mixture.id }}</p>
        <hr>
    </div>

    <!-- Dashboard Grid -->
    <div class="grid-dashboard">

        <!-- Left Column: Main Identity & Hazards -->
        <main class="col-main">

            <!-- 1. Classification Result Card -->
            <section class="card">
                <div class="card__header">
                    <h2 class="card__title">‚ö†Ô∏è V√Ωsledn√° Klasifikace (CLP)</h2>
                    {% set signal_class = 'danger' if mixture.final_signal_word == 'NEBEZPEƒå√ç' else 'warning' if
                    mixture.final_signal_word == 'VAROV√ÅN√ç' else 'info' %}
                    <span class="badge badge-{{ signal_class }} text-base">{{ mixture.final_signal_word or
                        'Neklasifikov√°no' }}</span>
                </div>

                <div class="card__body">
                    <div class="ghs-result-container mb-6">
                        <!-- Pictograms -->
                        <div class="d-flex gap-2 flex-wrap">
                            {% if mixture.final_ghs_codes %}
                            {% for code in mixture.final_ghs_codes.split(', ') %}
                            <div class="ghs-item-box">
                                <img src="{{ url_for('static', filename='GHS_Symbols/' + code + '.gif') }}"
                                    alt="{{ code }}" class="ghs-big-icon" onerror="this.style.display='none'">
                                <span class="text-xs font-bold">{{ code }}</span>
                            </div>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">Bez piktogram≈Ø</span>
                            {% endif %}
                        </div>


                    </div>

                    <hr class="mb-6" style="border-top-style: dashed;">

                    <!-- H-Statements Grid -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h4 class="text-lg font-bold mb-2 text-primary">Zdrav√≠ (Health)</h4>
                            {% if mixture.final_health_hazards %}
                            <div class="d-flex flex-column gap-2 text-sm">
                                {% for phrase in mixture.final_health_hazards.split(', ') %}
                                {% set val = h_phrases_display.get(phrase.strip()) %}
                                {% if val and val is iterable and val is not string %}
                                <div class="d-flex gap-2">
                                    <span class="font-bold text-danger"
                                        style="min-width: 240px; white-space: nowrap; flex-shrink: 0;">{{ val[0]
                                        }}</span>
                                    <span>{{ val[1] }}</span>
                                </div>
                                {% else %}
                                <div>{{ val or phrase }}</div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted text-sm">Bez nebezpeƒçn√Ωch vlastnost√≠ pro zdrav√≠.</p>
                            {% endif %}
                        </div>

                        <div class="col-12 mb-4">
                            <h4 class="text-lg font-bold mb-2 text-success">≈Ωivotn√≠ prost≈ôed√≠ (Env)</h4>
                            {% if mixture.final_environmental_hazards %}
                            <div class="d-flex flex-column gap-2 text-sm">
                                {% for phrase in mixture.final_environmental_hazards.split(', ') %}
                                {% set val = h_phrases_display.get(phrase.strip()) %}
                                {% if val and val is iterable and val is not string %}
                                <div class="d-flex gap-2">
                                    <span class="font-bold text-success"
                                        style="min-width: 240px; white-space: nowrap; flex-shrink: 0;">{{ val[0]
                                        }}</span>
                                    <span>{{ val[1] }}</span>
                                </div>
                                {% else %}
                                <div>{{ val or phrase }}</div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted text-sm">Bez nebezpeƒçn√Ωch vlastnost√≠ pro ≈æivotn√≠ prost≈ôed√≠.</p>
                            {% endif %}
                        </div>

                        <div class="col-12 mb-4">
                            <h4 class="text-lg font-bold mb-2 text-info">Pokyny pro bezpeƒçn√© zach√°zen√≠ (P-vƒõty)</h4>
                            {% if mixture.final_precautionary_statements %}
                            <div class="d-flex flex-column gap-2 text-sm">
                                {% for p_code in mixture.final_precautionary_statements.split(', ') %}
                                {% set p_text = p_phrases_text.get(p_code, "Text nenalezen") %}
                                <div class="d-flex gap-2">
                                    <span class="font-bold text-info"
                                        style="min-width: 80px; white-space: nowrap; flex-shrink: 0;">{{ p_code
                                        }}</span>
                                    <span>{{ p_text }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted text-sm">≈Ω√°dn√© specifick√© P-vƒõty.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Composition Table -->
            <section class="card">
                <div class="card__header">
                    <h2 class="card__title">üß™ Slo≈æen√≠ Smƒõsi</h2>
                    <span class="text-sm text-muted">{{ components|length }} slo≈æek</span>
                </div>
                <div class="table-responsive">
                    <table class="table-clean">
                        <thead>
                            <tr>
                                <th style="width: 40%">L√°tka</th>
                                <th style="width: 15%" class="text-right">Koncentrace</th>
                                <th style="width: 45%">Klasifikace (Slo≈æky)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr>
                                <td class="font-medium">{{ component.substance_name }}</td>
                                <td class="text-right font-bold">{{ "%.2f" | format(component.concentration) }} %</td>
                                <td class="text-xs">
                                    <div class="text-danger mb-1">{{ component.hazards if component.hazards }}</div>
                                    <div class="text-success">{{ component.env_hazards if component.env_hazards }}</div>
                                    {% if not component.hazards and not component.env_hazards %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="font-bold" style="background-color: var(--bg-tertiary);">
                                <td>CELKEM</td>
                                <td class="text-right">{{ "%.2f" | format(total_concentration) }} %</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% if total_concentration > 100.001 %}
                <div class="p-4">
                    <p class="alert alert-warning m-0 text-sm">‚ö†Ô∏è Celkov√° koncentrace p≈ôesahuje 100 %. Zkontrolujte
                        zad√°n√≠.</p>
                </div>
                {% endif %}
            </section>

            <!-- 3. Classification Log (Collapsible/Detailed) -->
            {% if mixture.classification_log %}
            <section class="card print-visible">
                <div class="card__header">
                    <h2 class="card__title">üìú Detailn√≠ Klasifikaƒçn√≠ Log</h2>
                </div>
                <!-- Simple log view -->
                <div class="table-responsive">
                    <table class="table-clean">
                        <thead>
                            <tr>
                                <th>Krok</th>
                                <th>Detail</th>
                                <th>V√Ωsledek</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in mixture.classification_log %}
                            <tr>
                                <td class="text-xs font-bold">{{ entry.step }}</td>
                                <td class="text-xs font-mono text-muted">{{ entry.detail }}</td>
                                <td>
                                    {% if "Klasifikov√°no" in entry.result %}
                                    <span class="badge badge-danger text-xs px-2 py-1">{{ entry.result }}</span>
                                    {% elif "OK" in entry.result %}
                                    <span class="badge badge-info text-xs px-2 py-1">{{ entry.result }}</span>
                                    {% else %}
                                    <span class="text-xs text-muted">{{ entry.result }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            {% endif %}

        </main>

        <!-- Right Column: Context & Metadata -->
        <aside class="col-sidebar">

            <!-- Metadata Card -->
            <div class="card">
                <div class="card__header">
                    <h2 class="card__title text-base">‚ÑπÔ∏è Informace</h2>
                </div>
                <div class="card__body p-4">
                    <div class="kv-list">
                        <div class="kv-item">
                            <span class="kv-label">ID Smƒõsi</span>
                            <span class="kv-value font-mono">{{ mixture.id }}</span>
                        </div>
                        <div class="kv-item">
                            <span class="kv-label">Vytvo≈ôeno</span>
                            <span class="kv-value">{{ mixture.created_date.strftime('%d.%m.%Y') }}</span>
                        </div>
                        <div class="kv-item">
                            <span class="kv-label">Posledn√≠ √∫prava</span>
                            <span class="kv-value">{{ mixture.created_date.strftime('%H:%M') }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ATE Values Card -->
            <div class="card">
                <div class="card__header">
                    <h2 class="card__title text-base">Hodnoty (ATE)</h2>
                </div>
                <div class="card__body p-4">
                    {% if mixture.final_atemix_oral or mixture.final_atemix_dermal or mixture.final_atemix_inhalation %}
                    <div class="kv-list">
                        <div class="kv-item">
                            <span class="kv-label">Or√°ln√≠</span>
                            <span class="kv-value">
                                {% if mixture.final_atemix_oral %}
                                {{ "%.0f" | format(mixture.final_atemix_oral) }} <small class="text-muted">mg/kg</small>
                                {% else %} <span class="text-muted">-</span> {% endif %}
                            </span>
                        </div>
                        <div class="kv-item">
                            <span class="kv-label">Derm√°ln√≠</span>
                            <span class="kv-value">
                                {% if mixture.final_atemix_dermal %}
                                {{ "%.0f" | format(mixture.final_atemix_dermal) }} <small
                                    class="text-muted">mg/kg</small>
                                {% else %} <span class="text-muted">-</span> {% endif %}
                            </span>
                        </div>
                        <div class="kv-item">
                            <span class="kv-label">Inhalaƒçn√≠</span>
                            <span class="kv-value">
                                {% if mixture.final_atemix_inhalation %}
                                {{ "%.2f" | format(mixture.final_atemix_inhalation) }} <small
                                    class="text-muted">mg/l</small>
                                {% else %} <span class="text-muted">-</span> {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-muted">
                        * Vypoƒçten√© odhady akutn√≠ toxicity smƒõsi (ATEmix).
                    </div>
                    {% else %}
                    <p class="text-sm text-muted m-0">Nejsou k dispozici data pro v√Ωpoƒçet ATE.</p>
                    {% endif %}
                </div>
            </div>

            <!-- History / Audit Mini-Log -->
            {% if audit_logs %}
            <div class="card no-print">
                <div class="card__header">
                    <h2 class="card__title text-base">Historie</h2>
                </div>
                <div class="card__body p-0">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table-clean" style="font-size: 0.75rem;">
                            <tbody>
                                {% for log in audit_logs[:5] %}
                                <tr>
                                    <td class="text-muted">{{ log.timestamp.strftime('%d.%m.%Y') }}</td>
                                    <td>
                                        <strong>{{ log.user.username }}</strong>: {{ log.action }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card__footer text-center">
                    <a href="#" class="text-xs text-primary" style="text-decoration: none;">Zobrazit cel√Ω log</a>
                </div>
            </div>
            {% endif %}

        </aside>

    </div>

    <!-- Print Footer -->
    <div class="only-print mt-8 text-center text-sm text-muted">
        <p>Dokument vygenerov√°n syst√©mem CLP Calculator. Odpov√≠d√° na≈ô√≠zen√≠ (ES) ƒç. 1272/2008.</p>
    </div>
</div>
{% endblock %}