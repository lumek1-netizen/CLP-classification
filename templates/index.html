{% extends "base.html" %}
{% from "macros.html" import render_pagination %}

{% block content %}
<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Seznam Klasifikovaných Směsí</h2>
    </div>

    <div class="search-container">
        <form action="{{ url_for('mixtures.index') }}" method="GET" class="search-form">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Hledat podle názvu směsi..."
                class="search-input">
            <button type="submit" class="button button-primary button-small">Hledat</button>
            {% if q %}
            <a href="{{ url_for('mixtures.index') }}" class="button button-small"
                style="background-color: var(--secondary-color); color: white; text-decoration: none;">Zrušit</a>
            {% endif %}
        </form>
    </div>

    <hr>

    {% if mixtures %}

    <div class="table-responsive">
        <table class="data-list">
            <thead class="table-secondary">
                <tr>
                    <th style="width: 30%;">Název Směsi</th>
                    <th style="width: 15%;">Datum Vytvoření</th>
                    <th style="width: 15%;">Signální Slovo</th>
                    <th style="width: 10%;">GHS Symboly</th>
                    <th style="width: 20%;">H-věty</th>
                    <th style="width: 10%;" class="text-center">Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for mixture in mixtures %}
                <tr class="clickable-row" data-href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                    style="cursor: pointer;">

                    <td>
                        <a href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                            style="color: inherit; text-decoration: none;" onclick="event.stopPropagation();">
                            {{ mixture.name }}
                        </a>
                    </td>

                    <td><small class="text-muted">{{ mixture.created_date.strftime('%Y-%m-%d %H:%M') }}</small></td>

                    <td>
                        {% if mixture.final_signal_word == 'NEBEZPEČÍ' %}
                        <span class="badge badge-danger">NEBEZPEČÍ</span>
                        {% elif mixture.final_signal_word == 'VAROVÁNÍ' %}
                        <span class="badge badge-warning">VAROVÁNÍ</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>
                        {% if mixture.final_ghs_codes %}
                        {% for code in mixture.final_ghs_codes.split(', ') %}
                        <span class="ghs-tag">{{ code }}</span>
                        {% endfor %}
                        {% else %}
                        N/A
                        {% endif %}
                    </td>

                    <td>
                        {% set all_h_phrases = [] %}
                        {% if mixture.final_health_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_health_hazards.split(', ') %}
                        {% endif %}
                        {% if mixture.final_environmental_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_environmental_hazards.split(', ') %}
                        {% endif %}

                        {{ all_h_phrases | join(', ') if all_h_phrases else '-' }}
                    </td>

                    <td class="text-center">
                        <a href="{{ url_for('mixtures.edit', mixture_id=mixture.id) }}" class="button button-small"
                            style="text-decoration: none; background-color: #17a2b8; color: white; margin-right: 5px;"
                            onclick="event.stopPropagation();">
                            Upravit
                        </a>

                        <form method="POST" action="{{ url_for('mixtures.delete', mixture_id=mixture.id) }}"
                            style="display:inline;" onclick="event.stopPropagation();">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="button button-delete button-small" title="Smazat směs"
                                onclick="return confirm('Opravdu chcete smazat směs {{ mixture.name }}? Tato akce je nevratná.');">
                                Smazat
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {{ render_pagination(pagination, 'mixtures.index') }}

    <div class="button-group d-flex justify-content-end">
        <a href="{{ url_for('mixtures.create') }}" class="button button-primary" style="text-decoration: none;">
            Vytvořit
            novou směs</a>
    </div>

    {% else %}
    <div class="alert alert-info mt-4 p-4 text-center" role="alert">
        <h4>Zatím nebyla vytvořena žádná směs.</h4>
        <p>Začněte přidáním nové směsi, aby bylo možné vypočítat její klasifikaci CLP.</p>
        <a href="{{ url_for('mixtures.create') }}" class="button button-primary mt-2" style="text-decoration: none;">➕
            Vytvořit První Směs</a>
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.clickable-row');
        rows.forEach(row => {
            row.addEventListener('click', function (e) {
                // Kontrola, zda nebyl klik na tlačítko (Upravit/Smazat), aby se zabránilo konfliktu navigace
                if (e.target.closest('a') || e.target.closest('button')) {
                    return;
                }
                // Přesměruje na URL uloženou v data-href (Detail směsi)
                const url = this.getAttribute('data-href');
                if (url) {
                    window.location.href = url;
                }
            });
        });
    });
</script>
{% endblock %}