{% extends "base.html" %}
{% from "macros.html" import render_pagination %}

{% block content %}
<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Seznam Klasifikovaných Směsí</h2>
    </div>

    <div class="search-container">
        <form action="{{ url_for('mixtures.index') }}" method="GET" class="search-form">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Hledat podle názvu směsi..."
                class="search-input">
            <button type="submit" class="button button-primary button-small">Hledat</button>
            {% if q %}
            <a href="{{ url_for('mixtures.index') }}" class="button button-small"
                style="background-color: var(--secondary-color); color: white; text-decoration: none;">Zrušit</a>
            {% endif %}
        </form>
    </div>

    <hr>

    {% if mixtures %}

    <div class="table-responsive">
        <table class="data-list">
            <thead class="table-secondary">
                <tr>
                    <th style="width: 25%;">Název Směsi</th>
                    <th style="width: 15%;">Datum Vytvoření</th>
                    <th style="width: 15%;">Signální Slovo</th>
                    <th style="width: 15%;">GHS Symboly</th>
                    <th style="width: 20%;">H-věty</th>
                    {% if current_user.has_role(['admin', 'editor']) %}
                    <th style="width: 10%;" class="text-center">Akce</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for mixture in mixtures %}
                <tr class="clickable-row" data-href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                    style="cursor: pointer;">

                    <td data-label="Název Směsi">
                        <a href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                            style="color: var(--primary-color); font-weight: 600; text-decoration: none;" onclick="event.stopPropagation();">
                            {{ mixture.name }}
                        </a>
                    </td>

                    <td data-label="Datum Vytvoření"><small class="text-muted">{{ mixture.created_date.strftime('%d.%m.%Y %H:%M') }}</small></td>

                    <td data-label="Signální Slovo">
                        {% if mixture.final_signal_word == 'NEBEZPEČÍ' %}
                        <span class="badge badge-danger">NEBEZPEČÍ</span>
                        {% elif mixture.final_signal_word == 'VAROVÁNÍ' %}
                        <span class="badge badge-warning">VAROVÁNÍ</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td data-label="GHS Symboly">
                        <div class="d-flex" style="gap: 0.25rem; flex-wrap: wrap;">
                        {% if mixture.final_ghs_codes %}
                        {% for code in mixture.final_ghs_codes.split(', ') %}
                        <img src="{{ url_for('static', filename='GHS_Symbols/' + code + '.gif') }}"
                             alt="{{ code }}" title="{{ code }}"
                             style="width: 24px; height: 24px;"
                             onerror="this.style.display='none'">
                        {% endfor %}
                        {% else %}
                        N/A
                        {% endif %}
                        </div>
                    </td>

                    <td data-label="H-věty">
                        {% set all_h_phrases = [] %}
                        {% if mixture.final_health_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_health_hazards.split(', ') %}
                        {% endif %}
                        {% if mixture.final_environmental_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_environmental_hazards.split(', ') %}
                        {% endif %}

                        <small>{{ all_h_phrases | join(', ') if all_h_phrases else '-' }}</small>
                    </td>

                    {% if current_user.has_role(['admin', 'editor']) %}
                    <td class="text-center" data-label="Akce">
                        <div class="d-flex justify-content-center" style="gap: 0.5rem;">
                            <a href="{{ url_for('mixtures.edit', mixture_id=mixture.id) }}" class="button button-small"
                                style="text-decoration: none; background-color: #17a2b8; color: white;"
                                onclick="event.stopPropagation();">
                                Upravit
                            </a>

                            <form method="POST" action="{{ url_for('mixtures.delete', mixture_id=mixture.id) }}"
                                style="display:inline;" onclick="event.stopPropagation();">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit" class="button button-delete button-small" title="Smazat směs"
                                    onclick="return confirm('Opravdu chcete smazat směs {{ mixture.name }}? Tato akce je nevratná.');">
                                    Smazat
                                </button>
                            </form>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {{ render_pagination(pagination, 'mixtures.index') }}

    {% if current_user.has_role(['admin', 'editor']) %}
    <div class="button-group d-flex justify-content-end">
        <a href="{{ url_for('mixtures.create') }}" class="button button-primary" style="text-decoration: none;">
            Vytvořit novou směs
        </a>
    </div>
    {% endif %}

    {% else %}
    <div class="alert alert-info mt-4 p-4 text-center" role="alert">
        <h4>Zatím nebyla vytvořena žádná směs.</h4>
        {% if current_user.has_role(['admin', 'editor']) %}
        <p>Začněte přidáním nové směsi, aby bylo možné vypočítat její klasifikaci CLP.</p>
        <a href="{{ url_for('mixtures.create') }}" class="button button-primary mt-2" style="text-decoration: none;">➕
            Vytvořit První Směs</a>
        {% else %}
        <p>Zatím zde nejsou žádná data k zobrazení.</p>
        {% endif %}
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.clickable-row');
        rows.forEach(row => {
            row.addEventListener('click', function (e) {
                // Kontrola, zda nebyl klik na tlačítko (Upravit/Smazat), aby se zabránilo konfliktu navigace
                if (e.target.closest('a') || e.target.closest('button')) {
                    return;
                }
                // Přesměruje na URL uloženou v data-href (Detail směsi)
                const url = this.getAttribute('data-href');
                if (url) {
                    window.location.href = url;
                }
            });
        });
    });
</script>
{% endblock %}