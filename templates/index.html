{% extends "base.html" %}
{% from "macros.html" import render_pagination %}

{% block content %}
<div class="container mt-5">

    <div class="sticky-action-bar">
        <div class="d-flex align-items-center" style="gap: 1.5rem;">
            <h2 style="margin: 0; white-space: nowrap;">Seznam smƒõs√≠</h2>
            <div style="flex-grow: 1;"></div>
            <form action="{{ url_for('mixtures.index') }}" method="GET" class="search-form"
                style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <input type="text" name="q" value="{{ q or '' }}" placeholder="Hledat..." class="search-input"
                    style="width: 250px;">
                <button type="submit" class="button button-primary button-small">üîç</button>
                {% if q %}
                <a href="{{ url_for('mixtures.index') }}" class="button button-small"
                    style="background-color: var(--secondary-color); color: white; text-decoration: none;">‚ùå</a>
                {% endif %}
            </form>
        </div>
        {% if current_user.has_role(['admin', 'editor']) %}
        <a href="{{ url_for('mixtures.create') }}" class="button button-primary" style="text-decoration: none;">
            ‚ûï Vytvo≈ôit novou smƒõs
        </a>
        {% endif %}
    </div>

    <hr>

    {% if mixtures %}

    <div class="table-responsive">
        <table class="data-list">
            <thead class="table-secondary">
                <tr>
                    <th style="width: 25%;">N√°zev Smƒõsi</th>
                    <th style="width: 15%;">Datum Vytvo≈ôen√≠ / Revize</th>
                    <th style="width: 15%;">Sign√°ln√≠ Slovo</th>
                    <th style="width: 15%;">GHS Symboly</th>
                    <th style="width: 20%;">H-vƒõty</th>
                    {% if current_user.has_role(['admin', 'editor']) %}
                    <th style="width: 10%;" class="text-center">Akce</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for mixture in mixtures %}
                <tr class="clickable-row" data-href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                    style="cursor: pointer;">

                    <td data-label="N√°zev Smƒõsi">
                        <a href="{{ url_for('mixtures.detail', mixture_id=mixture.id) }}"
                            style="color: var(--primary-color); font-weight: 600; text-decoration: none;"
                            onclick="event.stopPropagation();">
                            {{ mixture.name }}
                        </a>
                    </td>

                    <td data-label="Datum Vytvo≈ôen√≠ / Revize">
                        <small class="text-muted">{{ mixture.created_date.strftime('%d.%m.%Y') }}</small>
                        <br>
                        <small class="text-muted" style="font-size: 0.75em;">
                            {{ mixture.updated_at.strftime('%d.%m.%Y') if mixture.updated_at else '-' }}
                        </small>
                    </td>

                    <td data-label="Sign√°ln√≠ Slovo">
                        {% if mixture.final_signal_word == 'NEBEZPEƒå√ç' %}
                        <span class="badge badge-danger">NEBEZPEƒå√ç</span>
                        {% elif mixture.final_signal_word == 'VAROV√ÅN√ç' %}
                        <span class="badge badge-warning">VAROV√ÅN√ç</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td data-label="GHS Symboly">
                        <div class="d-flex" style="gap: 0.25rem; flex-wrap: wrap;">
                            {% if mixture.final_ghs_codes %}
                            {% for code in mixture.final_ghs_codes.split(', ') %}
                            <img src="{{ url_for('static', filename='GHS_Symbols/' + code + '.gif') }}" alt="{{ code }}"
                                title="{{ code }}" style="width: 24px; height: 24px;"
                                onerror="this.style.display='none'">
                            {% endfor %}
                            {% else %}
                            N/A
                            {% endif %}
                        </div>
                    </td>

                    <td data-label="H-vƒõty">
                        {% set all_h_phrases = [] %}
                        {% if mixture.final_health_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_health_hazards.split(', ') %}
                        {% endif %}
                        {% if mixture.final_environmental_hazards %}
                        {% set all_h_phrases = all_h_phrases + mixture.final_environmental_hazards.split(', ') %}
                        {% endif %}

                        <small>{{ all_h_phrases | join(', ') if all_h_phrases else '-' }}</small>
                    </td>

                    {% if current_user.has_role(['admin', 'editor']) %}
                    <td class="text-center" data-label="Akce">
                        <div class="d-flex justify-content-center" style="gap: 0.5rem;">
                            <a href="{{ url_for('mixtures.edit', mixture_id=mixture.id) }}" class="button button-small"
                                style="text-decoration: none; background-color: #17a2b8; color: white;"
                                onclick="event.stopPropagation();">
                                Upravit
                            </a>

                            <form method="POST" action="{{ url_for('mixtures.delete', mixture_id=mixture.id) }}"
                                style="display:inline;" onclick="event.stopPropagation();">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit" class="button button-delete button-small" title="Smazat smƒõs"
                                    onclick="return confirm('Opravdu chcete smazat smƒõs {{ mixture.name }}? Tato akce je nevratn√°.');">
                                    Smazat
                                </button>
                            </form>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {{ render_pagination(pagination, 'mixtures.index') }}

    {% else %}
    <div class="alert alert-info mt-4 p-4 text-center" role="alert">
        <h4>Zat√≠m nebyla vytvo≈ôena ≈æ√°dn√° smƒõs.</h4>
        {% if current_user.has_role(['admin', 'editor']) %}
        <p>Zaƒçnƒõte p≈ôid√°n√≠m nov√© smƒõsi, aby bylo mo≈æn√© vypoƒç√≠tat jej√≠ klasifikaci CLP.</p>
        <div style="margin-top: 1rem;">
            <a href="{{ url_for('mixtures.create') }}" class="button button-primary mt-2"
                style="text-decoration: none;">‚ûï
                Vytvo≈ôit Prvn√≠ Smƒõs</a>
        </div>
        {% else %}
        <p>Zat√≠m zde nejsou ≈æ√°dn√° data k zobrazen√≠.</p>
        {% endif %}
    </div>
    {% endif %}

</div>

<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.clickable-row');
        rows.forEach(row => {
            row.addEventListener('click', function (e) {
                // Kontrola, zda nebyl klik na tlaƒç√≠tko (Upravit/Smazat), aby se zabr√°nilo konfliktu navigace
                if (e.target.closest('a') || e.target.closest('button')) {
                    return;
                }
                // P≈ôesmƒõruje na URL ulo≈æenou v data-href (Detail smƒõsi)
                const url = this.getAttribute('data-href');
                if (url) {
                    window.location.href = url;
                }
            });
        });
    });
</script>
{% endblock %}