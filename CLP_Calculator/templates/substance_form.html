{% extends "base.html" %}

{% block content %}
<div class="container mt-5">

    {% if substance and substance.id %}
    <h1>üìù Editovat L√°tku: **{{ substance.name }}**</h1>
    {% else %}
    <h1>‚ûï P≈ôidat Novou L√°tku</h1>
    {% endif %}

    <hr>

    <form method="POST"
        action="{{ url_for('substances.edit', substance_id=substance.id) if substance and substance.id else url_for('substances.create') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="form-card mb-4">
            <h3>üè∑Ô∏è Z√°kladn√≠ Identifikace</h3>

            <div class="group-grid">
                <div class="form-group">
                    <label for="name">N√°zev L√°tky <span class="text-danger">*</span></label>
                    <input type="text" id="name" name="name"
                        value="{{ request.form.get('name') or (substance.name if substance else '') }}" required
                        placeholder="Nap≈ô. Ethanol">
                </div>

                <div class="form-group">
                    <label for="cas_number">CAS ƒå√≠slo</label>
                    <input type="text" id="cas_number" name="cas_number"
                        value="{{ request.form.get('cas_number') or (substance.cas_number if substance else '') }}"
                        placeholder="Nap≈ô. 64-17-5">
                </div>
            </div>

            <div class="form-group mt-3">
                <label for="ghs_codes">GHS K√≥dy (Piktogramy)</label>
                <input type="text" id="ghs_codes" name="ghs_codes"
                    value="{{ request.form.get('ghs_codes') or (substance.ghs_codes if substance else '') }}"
                    placeholder="Nap≈ô. GHS02, GHS07 (oddƒõlte ƒç√°rkou)">
            </div>
            <small class="hint mt-2">Zadejte GHS k√≥dy (piktogramy) oddƒõlen√© ƒç√°rkou, nap≈ô. GHS02, GHS07.</small>
        </div>


        <div class="form-card mb-4">
            <h3>‚öïÔ∏è H-Vƒõty (Zdrav√≠ Nebezpeƒç√≠)</h3>
            <div class="checkbox-group">
                {% for code, description in health_h_phrases.items() %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="health_h_phrases" value="{{ code }}"
                        id="health_{{ code }}" {% if code in selected_health_h_phrases %}checked{% endif %}>
                    <label class="form-check-label" for="health_{{ code }}">
                        <strong>{{ code }}</strong>: {{ description }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="form-card mb-4">
            <h3>üå≥ H-Vƒõty (≈Ωivotn√≠ Prost≈ôed√≠)</h3>
            <div class="checkbox-group">
                {% for code, description in env_h_phrases.items() %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="env_h_phrases" value="{{ code }}"
                        id="env_{{ code }}" {% if code in selected_env_h_phrases %}checked{% endif %}>
                    <label class="form-check-label" for="env_{{ code }}">
                        <strong>{{ code }}</strong>: {{ description }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="form-card mb-4">
            <h3>üß™ Akutn√≠ Toxicita (ATE Hodnoty - mg/kg nebo mg/l)</h3>
            <div class="group-grid">
                <div class="form-group">
                    <label for="ate_oral">ATE Or√°ln√≠ (mg/kg)</label>
                    <input type="number" step="0.01" min="0" id="ate_oral" name="ate_oral"
                        value="{{ request.form.get('ate_oral') or (substance.ate_oral if substance.ate_oral is not none else '') }}"
                        placeholder="Nap≈ô. 300">
                </div>

                <div class="form-group">
                    <label for="ate_dermal">ATE Derm√°ln√≠ (mg/kg)</label>
                    <input type="number" step="0.01" min="0" id="ate_dermal" name="ate_dermal"
                        value="{{ request.form.get('ate_dermal') or (substance.ate_dermal if substance.ate_dermal is not none else '') }}"
                        placeholder="Nap≈ô. 1100">
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_vapours">ATE Inhalaƒçn√≠ - P√°ry (mg/l)</label>
                    <input type="number" step="0.01" min="0" id="ate_inhalation_vapours" name="ate_inhalation_vapours"
                        value="{{ request.form.get('ate_inhalation_vapours') or (substance.ate_inhalation_vapours if substance.ate_inhalation_vapours is not none else '') }}"
                        placeholder="Nap≈ô. 15.0">
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_dusts_mists">ATE Inhalaƒçn√≠ - Prach/Mlha (mg/l)</label>
                    <input type="number" step="0.01" min="0" id="ate_inhalation_dusts_mists"
                        name="ate_inhalation_dusts_mists"
                        value="{{ request.form.get('ate_inhalation_dusts_mists') or (substance.ate_inhalation_dusts_mists if substance.ate_inhalation_dusts_mists is not none else '') }}"
                        placeholder="Nap≈ô. 0.8">
                </div>

                <div class="form-group">
                    <label for="ate_inhalation_gases">ATE Inhalaƒçn√≠ - Plyny (ppm)</label>
                    <input type="number" step="1" min="0" id="ate_inhalation_gases" name="ate_inhalation_gases"
                        value="{{ request.form.get('ate_inhalation_gases') or (substance.ate_inhalation_gases if substance.ate_inhalation_gases is not none else '') }}"
                        placeholder="Nap≈ô. 4500">
                </div>
            </div>
            <small class="hint mt-2">Pou≈æ√≠vejte pouze ƒçist√© ƒç√≠seln√© hodnoty. Desetinn√° m√≠sta oddƒõlujte teƒçkou. Nechte
                pr√°zdn√©, pokud nen√≠ relevantn√≠.</small>
        </div>


        <div class="form-card mb-4">
            <h3> Faktor (M-Factor)</h3>
            <div class="group-grid">
                <div class="form-group">
                    <label for="m_factor_acute">M-Faktor Akutn√≠ (Acute 1)</label>
                    <input type="number" step="1" min="1" id="m_factor_acute" name="m_factor_acute"
                        value="{{ request.form.get('m_factor_acute') or (substance.m_factor_acute if substance and substance.m_factor_acute is not none else 1) }}"
                        placeholder="Nap≈ô. 10">
                </div>

                <div class="form-group">
                    <label for="m_factor_chronic">M-Faktor Chronick√Ω (Chronic 1)</label>
                    <input type="number" step="1" min="1" id="m_factor_chronic" name="m_factor_chronic"
                        value="{{ request.form.get('m_factor_chronic') or (substance.m_factor_chronic if substance and substance.m_factor_chronic is not none else 1) }}"
                        placeholder="Nap≈ô. 10">
                </div>
            </div>
            <small class="hint mt-2">Zadejte celoƒç√≠selnou hodnotu (nap≈ô. 1, 10, 100). Standardn√≠ hodnota je 1.</small>
        </div>



        <div class="form-card mb-4">
            <h3>üìë Specifick√© Koncentraƒçn√≠ Limity (SCLs)</h3>
            <div class="form-group" id="scl_form_group">
                <label for="scl_data">SCLs (nap≈ô. C ‚â• 5% nebo 5% ‚â§ C < 25%)</label>
                        <div id="scl_container" class="mt-2">
                        </div>
                        <button type="button" id="add_scl_button" class="button button-secondary button-small mt-2">‚ûï
                            P≈ôidat SCL</button>

                        <input type="hidden" id="scl_data" name="scl_data"
                            value="{{ substance.scl_limits if substance else '' }}">

                        <small class="hint mt-2">Kliknƒõte na "P≈ôidat SCL" pro definov√°n√≠ specifick√Ωch limit≈Ø (podporuje
                            oper√°tory >=, >, <=, < i rozmez√≠).</small>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('substances.index') }}" class="button">Zpƒõt na seznam l√°tek</a>

            <button type="submit" class="button button-primary">
                {% if substance and substance.id %}
                üíæ Ulo≈æit Zmƒõny L√°tky
                {% else %}
                ‚úÖ Vytvo≈ôit L√°tku
                {% endif %}
            </button>
        </div>

    </form>
</div>

<script>
    // Z√≠sk√°n√≠ dat z Jinja kontextu
    const SCL_HAZARD_CATEGORIES = {{ scl_hazard_categories | tojson | safe }};

    const sclContainer = document.getElementById('scl_container');
    const addSclButton = document.getElementById('add_scl_button');
    const sclDataInput = document.getElementById('scl_data'); // Skryt√© pole pro fin√°ln√≠ string

    // 1. Funkce pro serializaci SCL formul√°≈ô≈Ø na fin√°ln√≠ string
    function serializeScls() {
        const rows = sclContainer.querySelectorAll('.scl-row');
        const scls = [];

        rows.forEach(row => {
            const hazard = row.querySelector('.scl-hazard').value;
            if (!hazard) return;

            const conds = [];

            // Prvn√≠ podm√≠nka
            const op1 = row.querySelector('.scl-op1').value;
            const val1 = row.querySelector('.scl-val1').value;
            if (op1 && val1 && !isNaN(parseFloat(val1))) {
                conds.push(`${op1} ${parseFloat(val1)}`);
            }

            // Druh√° podm√≠nka (pokud je aktivn√≠ rozmez√≠)
            const rangeCheck = row.querySelector('.scl-range-check');
            if (rangeCheck && rangeCheck.checked) {
                const op2 = row.querySelector('.scl-op2').value;
                const val2 = row.querySelector('.scl-val2').value;
                if (op2 && val2 && !isNaN(parseFloat(val2))) {
                    conds.push(`${op2} ${parseFloat(val2)}`);
                }
            }

            if (conds.length > 0) {
                // Sestav√≠me form√°t: Hazard: op1 val1; op2 val2
                scls.push(`${hazard}: ${conds.join('; ')}`);
            }
        });

        // Ulo≈æen√≠ do skryt√©ho pole pro odesl√°n√≠ do Flasku
        sclDataInput.value = scls.join(', ');
    }

    // Pomocn√° funkce pro vytvo≈ôen√≠ selectu oper√°toru
    function createOperatorSelect(className, defaultValue = '>=') {
        const select = document.createElement('select');
        select.className = `${className} form-control`;
        select.style.minWidth = '60px';
        const ops = ['>=', '>', '<=', '<'];
        ops.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op;
            opt.textContent = op;
            if (op === defaultValue) opt.selected = true;
            select.appendChild(opt);
        });
        return select;
    }

    // 2. Funkce pro vytvo≈ôen√≠ jednoho ≈ô√°dku SCL
    function createSclRow(defaultHazard = '', cond1 = { op: '>=', val: '' }, cond2 = null) {
        const div = document.createElement('div');
        div.className = 'scl-row card p-3 mb-3';
        div.style.border = '1px solid #ddd';
        div.style.backgroundColor = '#f9f9f9';

        const topRow = document.createElement('div');
        topRow.className = 'd-flex justify-content-between align-items-center mb-2';

        const hazardHeading = document.createElement('strong');
        hazardHeading.textContent = 'Kategorie nebezpeƒçnosti:';
        topRow.appendChild(hazardHeading);

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'button button-delete button-small';
        removeButton.textContent = '‚úñ Odstranit';
        removeButton.addEventListener('click', () => {
            div.remove();
            serializeScls();
        });
        topRow.appendChild(removeButton);
        div.appendChild(topRow);

        // Select pro hazard
        const selectHazard = document.createElement('select');
        selectHazard.className = 'scl-hazard form-control mb-3';

        let initialOption = document.createElement('option');
        initialOption.value = '';
        initialOption.textContent = 'Vyberte nebezpeƒç√≠...';
        selectHazard.appendChild(initialOption);

        SCL_HAZARD_CATEGORIES.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            if (category === defaultHazard) option.selected = true;
            selectHazard.appendChild(option);
        });
        div.appendChild(selectHazard);

        // Podm√≠nky
        const condsContainer = document.createElement('div');
        condsContainer.className = 'conds-container';

        // ≈ò√°dek 1
        const row1 = document.createElement('div');
        row1.className = 'd-flex align-items-center mb-2';
        row1.style.gap = '10px';

        row1.appendChild(document.createTextNode('Koncentrace (C) '));
        const op1Select = createOperatorSelect('scl-op1', cond1.op);
        row1.appendChild(op1Select);

        const val1Input = document.createElement('input');
        val1Input.type = 'number';
        val1Input.step = '0.01';
        val1Input.className = 'scl-val1 form-control';
        val1Input.placeholder = 'Limit %';
        val1Input.value = cond1.val;
        row1.appendChild(val1Input);
        row1.appendChild(document.createTextNode(' %'));

        condsContainer.appendChild(row1);

        // Range checkbox
        const rangeDiv = document.createElement('div');
        rangeDiv.className = 'mb-2';
        const rangeLabel = document.createElement('label');
        rangeLabel.style.fontWeight = 'normal';
        rangeLabel.style.cursor = 'pointer';

        const rangeCheck = document.createElement('input');
        rangeCheck.type = 'checkbox';
        rangeCheck.className = 'scl-range-check mr-2';
        rangeCheck.checked = !!cond2;
        rangeLabel.appendChild(rangeCheck);
        rangeLabel.appendChild(document.createTextNode(' P≈ôidat druhou podm√≠nku (rozmez√≠)'));
        rangeDiv.appendChild(rangeLabel);
        condsContainer.appendChild(rangeDiv);

        // ≈ò√°dek 2 (voliteln√Ω)
        const row2 = document.createElement('div');
        row2.className = 'scl-row2 d-flex align-items-center mb-2';
        row2.style.gap = '10px';
        row2.style.display = cond2 ? 'flex' : 'none';

        row2.appendChild(document.createTextNode('A z√°rove≈à (C) '));
        const op2Select = createOperatorSelect('scl-op2', cond2 ? cond2.op : '<');
        row2.appendChild(op2Select);

        const val2Input = document.createElement('input');
        val2Input.type = 'number';
        val2Input.step = '0.01';
        val2Input.className = 'scl-val2 form-control';
        val2Input.placeholder = 'Limit %';
        if (cond2) val2Input.value = cond2.val;
        row2.appendChild(val2Input);
        row2.appendChild(document.createTextNode(' %'));

        condsContainer.appendChild(row2);
        div.appendChild(condsContainer);

        // Event listener pro range checkbox
        rangeCheck.addEventListener('change', () => {
            row2.style.display = rangeCheck.checked ? 'flex' : 'none';
            serializeScls();
        });

        // Event listeners pro aktualizaci
        [selectHazard, op1Select, val1Input, op2Select, val2Input].forEach(el => {
            el.addEventListener('change', serializeScls);
            el.addEventListener('input', serializeScls);
        });

        sclContainer.appendChild(div);
    }

    // 3. Naƒçten√≠ existuj√≠c√≠ch SCLs p≈ôi naƒçten√≠ str√°nky (pro Editaci)
    function loadExistingScls() {
        if (sclDataInput.value) {
            const sclsArray = sclDataInput.value.split(',').map(s => s.trim()).filter(s => s);

            sclsArray.forEach(sclString => {
                // Nov√Ω form√°t: "Hazard: op1 val1; op2 val2"
                if (sclString.includes(':')) {
                    const [hazard, condsStr] = sclString.split(':').map(s => s.trim());
                    const condsParts = condsStr.split(';').map(s => s.trim());

                    let c1 = { op: '>=', val: '' };
                    let c2 = null;

                    condsParts.forEach((cp, idx) => {
                        const match = cp.match(/^([>=<]+)\s*([\d\.]+)$/);
                        if (match) {
                            if (idx === 0) {
                                c1 = { op: match[1], val: match[2] };
                            } else if (idx === 1) {
                                c2 = { op: match[1], val: match[2] };
                            }
                        }
                    });
                    createSclRow(hazard, c1, c2);
                } else if (sclString.includes('=')) {
                    // Star√Ω form√°t: "Hazard=Limit"
                    const [hazard, limit] = sclString.split('=').map(s => s.trim());
                    createSclRow(hazard, { op: '>=', val: limit });
                }
            });
        }
        serializeScls();
    }

    // 4. Inicializace
    loadExistingScls();

    // Listener pro tlaƒç√≠tko "P≈ôidat SCL"
    addSclButton.addEventListener('click', () => {
        createSclRow();
    });

</script>

{% endblock %}