{% extends "base.html" %}

{% block title %}
{% if mixture %}Editovat SmÄ›s: {{ mixture.name }}{% else %}VytvoÅ™it Novou SmÄ›s{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">

    <h1>{% if mixture %}ğŸ“ Editovat SmÄ›s: **{{ mixture.name }}**{% else %}â• VytvoÅ™it Novou SmÄ›s{% endif %}</h1>

    <hr>

    <form method="POST"
        action="{% if mixture %}{{ url_for('mixtures.edit', mixture_id=mixture.id) }}{% else %}{{ url_for('mixtures.create') }}{% endif %}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="form-card mb-4">
            <h3>ğŸ·ï¸ ZÃ¡kladnÃ­ Informace o SmÄ›si</h3>

            <div class="form-group">
                <label for="name">NÃ¡zev SmÄ›si <span class="text-danger">*</span></label>
                <input type="text" id="name" name="name"
                    value="{{ request.form.get('name') or (mixture.name if mixture else '') }}" required
                    placeholder="NapÅ™. ÄŒistÃ­cÃ­ prostÅ™edek XYZ">
            </div>
        </div>

        <div class="form-card mb-4">
            <h3>ğŸ§ª SloÅ¾enÃ­ SmÄ›si (Komponenty)</h3>

            <div id="components-container">
                <div class="group-grid text-muted mb-1" style="grid-template-columns: 2fr 1fr 60px; font-weight: bold;">
                    <div>LÃ¡tka</div>
                    <div>Koncentrace (%)</div>
                    <div></div>
                </div>
            </div>

            <button type="button" id="add-component-button" class="button button-secondary" style="margin-top: 15px;">
                â• PÅ™idat SloÅ¾ku
            </button>
            <p class="text-muted mt-2">UjistÄ›te se, Å¾e celkovÃ¡ koncentrace nepÅ™esahuje 100 %.</p>
        </div>

        <div class="button-group d-flex justify-content-between">
            <a href="{{ url_for('mixtures.index') }}" class="button button-link">ZpÄ›t</a>
            <button type="submit" class="button button-primary">
                {{ 'UloÅ¾it a PÅ™eklasifikovat SmÄ›s' if mixture else 'VytvoÅ™it a Klasifikovat SmÄ›s' }}
            </button>
        </div>
    </form>

</div>

<script>
    // PÅ™edÃ¡me data z Flask do JavaScriptu
    // Zde uÅ¾ nebudou objekty SQLAlchemy, ale pouze ÄistÃ© slovnÃ­ky, a proto to funguje.
    const ALL_SUBSTANCES = {{ substances | tojson }};
    const EXISTING_COMPONENTS = {{ existing_components | tojson }};

    const componentsContainer = document.getElementById('components-container');
    const addComponentButton = document.getElementById('add-component-button');

    let componentCount = 0;

    /**
     * VytvoÅ™Ã­ rozbalovacÃ­ seznam (dropdown) se vÅ¡emi lÃ¡tkami.
     */
    function createSubstanceSelect(selectedValue = null) {
        const select = document.createElement('select');
        select.name = 'substance_id';
        select.required = true;
        select.classList.add('form-control', 'substance-select');

        let defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- Vyberte lÃ¡tku ---';
        defaultOption.disabled = true;
        select.appendChild(defaultOption);

        ALL_SUBSTANCES.forEach(substance => {
            const option = document.createElement('option');
            option.value = substance.id;
            option.textContent = `${substance.name} (ID: ${substance.id})`;
            if (selectedValue !== null && String(substance.id) === String(selectedValue)) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        if (selectedValue === null) {
            defaultOption.selected = true;
        }

        return select;
    }

    /**
     * VytvoÅ™Ã­ kompletnÃ­ Å™Ã¡dek pro komponentu (lÃ¡tka + koncentrace + smazÃ¡nÃ­).
     */
    function addComponentRow(substanceId = null, concentration = null) {
        componentCount++;

        const rowDiv = document.createElement('div');
        rowDiv.classList.add('component-row', 'group-grid', 'mb-2');
        // Styl pro 3 sloupce: LÃ¡tka (2 dÃ­ly), Koncentrace (1 dÃ­l), TlaÄÃ­tko (pevnÃ¡ Å¡Ã­Å™ka)
        rowDiv.style.cssText = 'grid-template-columns: 2fr 1fr 60px; align-items: center;';
        rowDiv.dataset.id = componentCount;

        // 1. Sloupec: LÃ¡tka (Dropdown)
        const selectGroup = document.createElement('div');
        selectGroup.classList.add('form-group-inline'); // PouÅ¾Ã­vÃ¡me tÅ™Ã­du inline pro zarovnÃ¡nÃ­ uvnitÅ™ buÅˆky
        const select = createSubstanceSelect(substanceId);
        selectGroup.appendChild(select);

        // 2. Sloupec: Koncentrace (%)
        const concentrationGroup = document.createElement('div');
        concentrationGroup.classList.add('form-group-inline');
        const input = document.createElement('input');
        input.type = 'number';
        input.name = 'concentration';
        input.required = true;
        input.min = '0.001';
        input.step = '0.001';
        input.placeholder = 'Konc. %';
        input.classList.add('form-control');

        if (concentration !== null) {
            // ZobrazenÃ­ koncentrace s pÅ™esnostÃ­ na 3 desetinnÃ¡ mÃ­sta
            input.value = parseFloat(concentration).toFixed(3);
        }
        concentrationGroup.appendChild(input);

        // 3. Sloupec: TlaÄÃ­tko pro odstranÄ›nÃ­
        const deleteGroup = document.createElement('div');
        deleteGroup.classList.add('form-group-inline', 'd-flex', 'align-items-center', 'justify-content-center');
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.innerHTML = 'âœ–ï¸';
        deleteButton.title = 'Odstranit sloÅ¾ku';
        deleteButton.classList.add('button', 'button-danger', 'button-icon-small');

        deleteButton.addEventListener('click', () => {
            // SmÄ›s musÃ­ obsahovat alespoÅˆ jednu komponentu
            if (componentsContainer.querySelectorAll('.component-row').length > 1) {
                rowDiv.remove();
            } else {
                alert('SmÄ›s musÃ­ obsahovat alespoÅˆ jednu sloÅ¾ku.');
            }
        });
        deleteGroup.appendChild(deleteButton);

        rowDiv.appendChild(selectGroup);
        rowDiv.appendChild(concentrationGroup);
        rowDiv.appendChild(deleteGroup);
        componentsContainer.appendChild(rowDiv);
    }

    /**
     * NaÄte existujÃ­cÃ­ komponenty pÅ™i editaci.
     */
    function loadExistingComponents() {
        if (EXISTING_COMPONENTS && EXISTING_COMPONENTS.length > 0) {
            EXISTING_COMPONENTS.forEach(comp => {
                addComponentRow(comp.substance_id, comp.concentration);
            });
        }

        // PÅ™idÃ¡me jeden prÃ¡zdnÃ½ Å™Ã¡dek pro novou smÄ›s nebo pro snadnÃ© pÅ™idÃ¡nÃ­ novÃ© pÅ™i editaci
        if (!EXISTING_COMPONENTS || EXISTING_COMPONENTS.length === 0) {
            addComponentRow();
        }
    }

    // Inicializace
    document.addEventListener('DOMContentLoaded', () => {
        loadExistingComponents();
    });

    // Listener pro tlaÄÃ­tko "PÅ™idat SloÅ¾ku"
    addComponentButton.addEventListener('click', () => {
        addComponentRow();
    });

</script>
{% endblock %}